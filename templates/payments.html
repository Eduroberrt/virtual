{% extends 'main.html' %}
{% load currency_filters %}

{% block title %}Payment History - Young PG Virtual{% endblock %}

{% block content %}
<div class="container-fluid py-4" style="margin-bottom: 120px;">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h4 fw-bold mb-2">Payment History</h1>
                    <p class="text-muted mb-0" style="font-size: 0.875rem;">Time is in America/Los_Angeles time zone. The last 90 days are shown.</p>
                </div>
                <div>
                    <a href="/dashboard/" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>

            <!-- Payment History Card -->
            <div class="payments-card">
                <div class="payments-card-header">
                    <div class="auth-icon">
                        <i class="fas fa-receipt"></i>
                    </div>
                    <h5 class="payments-card-title">Transaction History</h5>
                    <p class="payments-card-subtitle">View your recent transactions and payment activity</p>
                </div>
                <div class="payments-card-body">
                    <div class="table-container">
                        <table class="transactions-table">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Amount</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="paymentTableBody">
                                <tr>
                                    <td colspan="3" class="text-center py-4">
                                        <div class="loading-state">
                                            <div class="loading-spinner"></div>
                                            <span class="loading-text">Loading transaction history...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Pagination -->
            <div class="pagination-wrapper mt-4">
                <div class="pagination-container" id="paginationControls">
                    <!-- Pagination will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadTransactionHistory();
});

let currentPage = 1;
let totalPages = 1;
let allTransactions = [];

async function loadTransactionHistory() {
    try {
        showLoading(true);
        
        const response = await fetch(`/api/transactions/?page=${currentPage}`, {
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to load transaction history');
        }
        
        const data = await response.json();
        
        if (data.transactions) {
            allTransactions = data.transactions;
            totalPages = data.total_pages;
            currentPage = data.current_page;
            
            renderTransactions();
            renderPagination();
        } else {
            showEmptyState();
        }
        
    } catch (error) {
        console.error('Error loading transaction history:', error);
        showErrorState();
    } finally {
        showLoading(false);
    }
}

function renderTransactions() {
    const tbody = document.getElementById('paymentTableBody');
    
    if (allTransactions.length === 0) {
        showEmptyState();
        return;
    }
    
    tbody.innerHTML = allTransactions.map(transaction => {
        const date = new Date(transaction.created_at);
        const formattedDate = formatDateToLA(date);
        const amount = parseFloat(transaction.amount);
        const isDeposit = transaction.transaction_type.includes('DEPOSIT');
        const isRefund = transaction.transaction_type === 'REFUND';
        const isRental = transaction.transaction_type === 'RENTAL';
        
        let icon, colorClass, sign;
        
        if (isDeposit) {
            icon = 'fas fa-plus-circle';
            colorClass = 'text-success';
            sign = '+';
        } else if (isRefund) {
            icon = 'fas fa-undo';
            colorClass = 'text-info';
            sign = '+';
        } else if (isRental) {
            icon = 'fas fa-minus-circle';
            colorClass = 'text-danger';
            sign = '-';
        } else {
            icon = 'fas fa-exchange-alt';
            colorClass = 'text-warning';
            sign = amount >= 0 ? '+' : '-';
        }
        
        // All amounts are now stored in NGN - no conversion needed
        const nairaAmount = Math.abs(amount);
        
        return `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <i class="${icon} ${colorClass} me-2"></i>
                        <div>
                            <span class="fw-medium">${transaction.description}</span>
                            ${transaction.rental && transaction.rental.phone_number ? 
                                `<br><small class="text-muted">Phone: ${transaction.rental.phone_number}</small>` : 
                                ''}
                        </div>
                    </div>
                </td>
                <td>
                    <span class="fw-bold ${colorClass}">${sign}â‚¦${formatCurrency(nairaAmount)}</span>
                </td>
                <td>
                    <span class="text-muted">${formattedDate}</span>
                </td>
            </tr>
        `;
    }).join('');
}

function showLoading(show) {
    const tbody = document.getElementById('paymentTableBody');
    
    if (show) {
        tbody.innerHTML = `
            <tr>
                <td colspan="3" class="text-center py-4">
                    <div class="d-flex justify-content-center align-items-center">
                        <div class="spinner-border text-primary me-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span class="text-muted">Loading transaction history...</span>
                    </div>
                </td>
            </tr>
        `;
    }
}

function showEmptyState() {
    const tbody = document.getElementById('paymentTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="3" class="text-center py-5">
                <div class="text-muted">
                    <i class="fas fa-receipt fa-3x mb-3 opacity-50"></i>
                    <h5>No transactions found</h5>
                    <p class="mb-0">Your transaction history will appear here when you make payments or rentals.</p>
                </div>
            </td>
        </tr>
    `;
}

function showErrorState() {
    const tbody = document.getElementById('paymentTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="3" class="text-center py-5">
                <div class="text-danger">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <h5>Error loading transactions</h5>
                    <p class="mb-2">Unable to load your transaction history.</p>
                    <button class="btn btn-outline-primary btn-sm" onclick="loadTransactionHistory()">
                        <i class="fas fa-redo me-1"></i>Try Again
                    </button>
                </div>
            </td>
        </tr>
    `;
}

function renderPagination() {
    const pagination = document.getElementById('paginationControls');
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let paginationHTML = '<div class="pagination-buttons">';
    
    // Previous button
    if (currentPage > 1) {
        paginationHTML += `
            <button class="pagination-btn pagination-prev" onclick="changePage(${currentPage - 1})" aria-label="Previous">
                <i class="fas fa-chevron-left"></i> Previous
            </button>
        `;
    }
    
    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        paginationHTML += `<button class="pagination-btn pagination-number" onclick="changePage(1)">1</button>`;
        if (startPage > 2) {
            paginationHTML += `<span class="pagination-ellipsis">...</span>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        if (i === currentPage) {
            paginationHTML += `<button class="pagination-btn pagination-number active">${i}</button>`;
        } else {
            paginationHTML += `<button class="pagination-btn pagination-number" onclick="changePage(${i})">${i}</button>`;
        }
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            paginationHTML += `<span class="pagination-ellipsis">...</span>`;
        }
        paginationHTML += `<button class="pagination-btn pagination-number" onclick="changePage(${totalPages})">${totalPages}</button>`;
    }
    
    // Next button
    if (currentPage < totalPages) {
        paginationHTML += `
            <button class="pagination-btn pagination-next" onclick="changePage(${currentPage + 1})" aria-label="Next">
                Next <i class="fas fa-chevron-right"></i>
            </button>
        `;
    }
    
    paginationHTML += '</div>';
    pagination.innerHTML = paginationHTML;
}

function changePage(page) {
    if (page >= 1 && page <= totalPages && page !== currentPage) {
        currentPage = page;
        loadTransactionHistory();
        
        // Scroll to top of table
        document.querySelector('.payments-card').scrollIntoView({ 
            behavior: 'smooth',
            block: 'start'
        });
    }
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(amount);
}

function formatDateToLA(date) {
    return new Intl.DateTimeFormat('en-US', {
        timeZone: 'America/Los_Angeles',
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
    }).format(date);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<style>
/* Payments page styles using website theme */

/* Main payments card */
.payments-card {
    background: white;
    border-radius: 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(0, 0, 0, 0.05);
    position: relative;
    overflow: hidden;
}

.payments-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(135deg, #198754 0%, #20c997 100%);
}

.payments-card-header {
    padding: 3rem 2.5rem 2rem;
    text-align: center;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

.payments-card-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #333;
    margin: 1rem 0 0.5rem 0;
}

.payments-card-subtitle {
    font-size: 0.875rem;
    color: #666;
    margin: 0;
    line-height: 1.5;
}

.payments-card-body {
    padding: 0;
}

/* Table styles */
.table-container {
    overflow-x: auto;
}

.transactions-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
}

.transactions-table thead th {
    background: linear-gradient(135deg, #198754 0%, #20c997 100%);
    color: white;
    padding: 1rem 1.25rem;
    font-weight: 600;
    text-align: left;
    border: none;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.transactions-table tbody td {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    vertical-align: middle;
}

.transactions-table tbody tr {
    transition: background-color 0.2s ease;
}

.transactions-table tbody tr:hover {
    background-color: rgba(23, 162, 184, 0.02);
}

.transactions-table tbody tr:last-child td {
    border-bottom: none;
}

/* Loading state */
.loading-state {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 3rem 1.5rem;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(25, 135, 84, 0.2);
    border-top: 3px solid #198754;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 1rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-text {
    color: #666;
    font-size: 1rem;
}

/* Empty and error states */
.empty-state, .error-state {
    padding: 3rem 1.5rem;
    text-align: center;
    color: #666;
}

.empty-state i, .error-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.error-state {
    color: #dc3545;
}

.error-state i {
    color: #dc3545;
}

/* Pagination styles */
.pagination-wrapper {
    display: flex;
    justify-content: center;
}

.pagination-container {
    display: flex;
    justify-content: center;
    align-items: center;
}

.pagination-buttons {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.pagination-btn {
    padding: 0.75rem 1rem;
    border: 2px solid #e9ecef;
    background: white;
    color: #333;
    border-radius: 10px;
    font-weight: 500;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.pagination-btn:hover {
    border-color: #198754;
    color: #198754;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(25, 135, 84, 0.2);
}

.pagination-btn.active {
    background: linear-gradient(135deg, #198754 0%, #146c43 100%);
    border-color: #198754;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(25, 135, 84, 0.3);
}

.pagination-number {
    min-width: 45px;
    justify-content: center;
}

.pagination-prev, .pagination-next {
    font-weight: 600;
}

.pagination-ellipsis {
    padding: 0.75rem 0.5rem;
    color: #666;
    font-weight: 500;
}

/* Transaction row styling */
.transaction-icon {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 0.75rem;
    font-size: 0.875rem;
}

.transaction-content {
    display: flex;
    align-items: center;
}

.transaction-details {
    flex: 1;
}

.transaction-description {
    font-weight: 500;
    color: #333;
    margin-bottom: 0.25rem;
}

.transaction-meta {
    font-size: 0.8rem;
    color: #666;
}

.transaction-amount {
    text-align: right;
}

.amount-primary {
    font-weight: 600;
    font-size: 1rem;
    margin-bottom: 0.25rem;
}

.amount-secondary {
    font-size: 0.8rem;
    color: #666;
}

.text-success {
    color: #20c997 !important;
}

.text-danger {
    color: #dc3545 !important;
}

.text-info {
    color: #198754 !important;
}

.text-warning {
    color: #ffc107 !important;
}

/* Responsive design */
@media (max-width: 768px) {
    .payments-card-header {
        padding: 2rem 1.5rem 1.5rem;
    }
    
    .transactions-table thead th,
    .transactions-table tbody td {
        padding: 1rem;
    }
    
    .transactions-table thead th {
        font-size: 0.8rem;
    }
    
    .transactions-table tbody td {
        font-size: 0.875rem;
    }
    
    .pagination-buttons {
        gap: 0.25rem;
    }
    
    .pagination-btn {
        padding: 0.6rem 0.8rem;
        font-size: 0.8rem;
    }
    
    .pagination-number {
        min-width: 40px;
    }
    
    .transaction-icon {
        width: 30px;
        height: 30px;
        font-size: 0.75rem;
        margin-right: 0.5rem;
    }
    
    .loading-state {
        padding: 2rem 1rem;
    }
    
    .loading-spinner {
        width: 30px;
        height: 30px;
    }
}

@media (max-width: 576px) {
    .transaction-content {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .transaction-amount {
        text-align: left;
        width: 100%;
    }
    
    .pagination-prev .fas,
    .pagination-next .fas {
        display: none;
    }
}

/* Dark mode overrides for payments page */
[data-theme="dark"] .payments-card {
    background: #000000 !important;
    border: 1px solid var(--success-color) !important;
    color: #ffffff !important;
}

[data-theme="dark"] .payments-card-header {
    background: #000000 !important;
    color: #ffffff !important;
    border-bottom: 1px solid var(--success-color) !important;
}

[data-theme="dark"] .payments-card-body {
    background: #000000 !important;
    color: #ffffff !important;
}

[data-theme="dark"] .payments-card-title {
    color: #ffffff !important;
}

[data-theme="dark"] .payments-card-subtitle {
    color: #b3b3b3 !important;
}

[data-theme="dark"] .table {
    background: #000000 !important;
    color: #ffffff !important;
}

[data-theme="dark"] .table th,
[data-theme="dark"] .table td {
    background: #000000 !important;
    color: #ffffff !important;
    border-color: #404040 !important;
}

[data-theme="dark"] .text-muted {
    color: #b3b3b3 !important;
}

[data-theme="dark"] .text-dark {
    color: #ffffff !important;
}

/* Dark mode pagination styling (transparent like history page) */
[data-theme="dark"] .pagination-btn {
    background: #000000 !important;
    border-color: #404040 !important;
    color: #ffffff !important;
}

[data-theme="dark"] .pagination-btn:hover {
    border-color: #198754 !important;
    color: #198754 !important;
    background: #1a1a1a !important;
}

[data-theme="dark"] .pagination-btn.active {
    background: linear-gradient(135deg, #198754 0%, #146c43 100%) !important;
    border-color: #198754 !important;
    color: white !important;
}

[data-theme="dark"] .pagination-ellipsis {
    color: #b3b3b3 !important;
}
</style>
{% endblock %}
