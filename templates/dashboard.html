{% extends 'main.html' %}
{% load currency_filters %}

{% block title %}Dashboard - Young PG Virtual{% endblock %}

{% block content %}
<div class="dashboard-content">
<div class="row g-0">
    <!-- SMS Verifications Section -->
    <div class="col-12 col-lg-5 border-end">
        <div class="p-2 p-md-3 p-lg-4">
            <h2 class="h5 fw-bold mb-2">SMS Verifications</h2>

            <div class="text-muted mb-3" style="font-size: 0.875rem;">
                <p class="mb-1">Rent a phone for 7 minutes.</p>
                <p class="mb-0">Credits are only used if you receive the SMS code.</p>
            </div>

            <!-- Service Search and Settings -->
            <div class="d-flex gap-2 mb-3">
                <div class="input-group flex-grow-1">
                    <span class="input-group-text" style="font-size: 0.875rem;">Service</span>
                    <input type="text" class="form-control" id="serviceFilter" placeholder="Search services..." style="font-size: 0.875rem;">
                    <button class="btn btn-primary btn-sm" type="button">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <button class="btn btn-primary btn-sm" type="button" id="settingsToggle">
                    <i class="fas fa-cog"></i>
                </button>
            </div>

            <!-- Settings Panel -->
            <div class="settings-panel" id="settingsPanel" style="display: none;">
                <div class="card border-0 bg-light mb-3">
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted fw-medium" style="font-size: 0.75rem;">Number Preferences (Optional)</small>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearAllFilters()" style="font-size: 0.7rem; padding: 0.2rem 0.5rem;">
                                <i class="fas fa-times me-1"></i>Clear All
                            </button>
                        </div>
                        <div class="mb-2">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text" style="min-width: 100px; font-size: 0.8rem;">Area codes</span>
                                <input type="text" class="form-control" id="areaCodes" placeholder="503, 202, 404 (optional)" style="font-size: 0.8rem;" title="Enter 3-digit US area codes separated by commas">
                            </div>
                            <small class="text-muted" style="font-size: 0.75rem;">
                                Popular area codes: 503 (OR), 202 (DC), 404 (GA), 213 (CA). Increases price by 20%.
                                <button type="button" class="btn btn-link p-0 ms-1" style="font-size: 0.7rem; vertical-align: baseline;" onclick="clearAreaCodes()">Clear</button>
                            </small>
                        </div>

                        <div class="mb-2">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text" style="min-width: 100px; font-size: 0.8rem;">Carriers</span>
                                <input type="text" class="form-control" id="carriers" placeholder="tmo, vz, att (optional)" style="font-size: 0.8rem;" title="Enter carrier codes separated by commas">
                            </div>
                            <small class="text-muted" style="font-size: 0.75rem;">
                                Use: tmo (T-Mobile), vz (Verizon), att (AT&T). Increases price by 20%. 
                                <a href="#carrierInfoModal" data-bs-toggle="modal" class="text-decoration-none">More info</a>
                                <button type="button" class="btn btn-link p-0 ms-1" style="font-size: 0.7rem; vertical-align: baseline;" onclick="clearCarriers()">Clear</button>
                            </small>
                        </div>

                        <div class="mb-0">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text" style="min-width: 100px; font-size: 0.8rem;">Phone</span>
                                <input type="text" class="form-control" id="phone" placeholder="1112223333 (optional)" style="font-size: 0.8rem;" title="Enter specific 10-digit phone number">
                            </div>
                            <small class="text-muted" style="font-size: 0.75rem;">
                                Specific 10-digit phone number. Increases price by 20%.
                                <button type="button" class="btn btn-link p-0 ms-1" style="font-size: 0.7rem; vertical-align: baseline;" onclick="clearPhone()">Clear</button>
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Services Table -->
            <div class="border rounded" style="height: 250px; overflow-y: auto;">
                <table class="table table-hover mb-0 table-sm">
                    <thead class="table-light sticky-top">
                        <tr style="font-size: 0.8rem;">
                            <th>Service</th>
                            <th>Price</th>
                            <th class="text-center" style="width: 40px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for service in services %}
                        <tr class="service-row" data-service="{{ service.name }}" data-code="{{ service.code }}">
                            <td class="service-name">
                                <div class="fw-medium" style="font-size: 0.85rem;">{{ service.name }}</div>
                            </td>
                            <td class="price">
                                <div class="fw-medium" style="font-size: 0.85rem;">{{ service.get_naira_price|format_naira }}</div>
                            </td>
                            <td class="text-center">
                                <button class="btn btn-link p-0 favorite-btn" data-favorite="false">
                                    <span class="text-muted">‚ô°</span>
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="text-center py-4">
                                <div class="text-muted">
                                    <p class="mb-2" style="font-size: 0.9rem;">No services available.</p>
                                    <small>Please contact admin to add services.</small>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Rented Numbers Section -->
    <div class="col-12 col-lg-7">
        <div class="p-2 p-md-3 p-lg-4">
            <h2 class="h5 fw-bold mb-2">Rented numbers</h2>

            <div class="text-muted mb-3" style="font-size: 0.875rem;">
                <p class="mb-1">No need to refresh the page to get the code.</p>
                <p class="mb-0">You can get more SMS to the same number for free when üîÅ is displayed.</p>
            </div>

            <!-- Active Rentals Counter -->
            <div class="d-flex justify-content-end mb-3">
                <div class="border border-2 rounded px-3 py-1">
                    <span class="fw-medium" id="rentalCounter">0 / 20</span>
                </div>
            </div>

            <!-- Rentals Table -->
            <div class="table-responsive">
                <table class="table table-hover table-sm">
                    <thead class="table-light">
                        <tr style="font-size: 0.8rem;">
                            <th>ID</th>
                            <th>Service</th>
                            <th>Phone</th>
                            <th>Code</th>
                            <th>Cost</th>
                            <th>TTL</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="7" class="text-center py-4">
                                <div class="text-muted">
                                    <p class="mb-2" style="font-size: 0.9rem;">No rented number yet.</p>
                                    <small>Click on a service to rent a number.</small>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- History Link -->
            <div class="text-center mt-4">
                <a href="/history/" class="text-decoration-none">View number history</a>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Carrier Info Modal -->
<div class="modal fade" id="carrierInfoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Why choose carrier</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>There are 3 carriers in the USA: T-Mobile (tmo), Verizon (vz), and AT&T (att).</p>
                <p>If you're experiencing issues on services like Tinder, where it says an account already exists, we recommend you try Verizon, or AT&T.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Full Message Modal -->
<div class="modal fade" id="fullMessageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Full Message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="font-monospace">Your WhatsApp verification code is: 123456</p>
                <p class="font-monospace">Don't share this code with anyone.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Settings panel toggle
    const settingsToggle = document.getElementById('settingsToggle');
    const settingsPanel = document.getElementById('settingsPanel');
    
    settingsToggle.addEventListener('click', function() {
        if (settingsPanel.style.display === 'none') {
            settingsPanel.style.display = 'block';
        } else {
            settingsPanel.style.display = 'none';
        }
    });

    // Service search functionality
    const serviceFilter = document.getElementById('serviceFilter');
    const serviceRows = document.querySelectorAll('.service-row');
    
    serviceFilter.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        let hasVisibleServices = false;
        
        serviceRows.forEach(row => {
            const serviceName = row.getAttribute('data-service').toLowerCase();
            if (serviceName.includes(searchTerm)) {
                row.style.display = '';
                hasVisibleServices = true;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Show/hide "service not listed" option based on search results
        handleServiceNotListed(searchTerm, hasVisibleServices);
        
        // Re-sort visible services by favorites
        if (searchTerm === '') {
            sortServicesByFavorites();
        }
    });

    // Favorite toggle functionality
    const favoriteButtons = document.querySelectorAll('.favorite-btn');
    
    // Load saved favorites from localStorage
    loadFavorites();
    
    favoriteButtons.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent service row click
            
            const row = this.closest('.service-row');
            const serviceCode = row.getAttribute('data-code');
            const isFavorite = this.getAttribute('data-favorite') === 'true';
            const heartIcon = this.querySelector('span');
            
            if (isFavorite) {
                // Remove from favorites
                this.setAttribute('data-favorite', 'false');
                heartIcon.textContent = '‚ô°';
                heartIcon.className = 'text-muted';
                removeFavorite(serviceCode);
            } else {
                // Add to favorites
                this.setAttribute('data-favorite', 'true');
                heartIcon.textContent = '‚ô•';
                heartIcon.className = 'text-danger';
                addFavorite(serviceCode);
            }
            
            // Re-sort the services table
            sortServicesByFavorites();
        });
    });

    // Service row click functionality
    serviceRows.forEach(row => {
        row.addEventListener('click', function(e) {
            console.log('Service row clicked:', this); // Debug log
            
            // Don't trigger if clicking on favorite button
            if (e.target.closest('.favorite-btn')) {
                console.log('Clicked on favorite button, ignoring'); // Debug log
                return;
            }
            
            const serviceName = this.getAttribute('data-service');
            const serviceCode = this.getAttribute('data-code');
            const price = this.querySelector('.price .fw-medium').textContent;
            
            console.log('Service details:', { serviceName, serviceCode, price }); // Debug log
            
            // Get settings values
            const areaCodes = document.getElementById('areaCodes').value.split(',').map(code => code.trim()).filter(code => code);
            const carriers = document.getElementById('carriers').value.split(',').map(carrier => carrier.trim()).filter(carrier => carrier);
            const phoneRaw = document.getElementById('phone').value.trim();
            const phone = phoneRaw ? phoneRaw.replace(/\D/g, '') : null; // Remove any non-digit characters
            
            console.log('Settings values:', { areaCodes, carriers, phone }); // Debug log
            
            // Rent the service immediately without confirmation
            console.log('Renting service immediately'); // Debug log
            rentNumber(serviceCode, false, false, areaCodes, carriers, phone);
        });
    });

    // Add real-time validation for input fields
    const areaCodes = document.getElementById('areaCodes');
    const carriers = document.getElementById('carriers');
    const phone = document.getElementById('phone');
    
    // Area codes validation
    areaCodes.addEventListener('input', function() {
        const value = this.value.trim();
        if (value && !/^[\d,\s]+$/.test(value)) {
            this.classList.add('is-invalid');
            showValidationTooltip(this, 'Only numbers and commas allowed (e.g., 503, 202, 404)');
        } else {
            this.classList.remove('is-invalid');
            hideValidationTooltip(this);
        }
    });
    
    // Carriers validation
    carriers.addEventListener('input', function() {
        const value = this.value.trim();
        if (value) {
            const validCarriers = ['tmo', 'vz', 'att'];
            const enteredCarriers = value.toLowerCase().split(',').map(c => c.trim());
            const invalidCarriers = enteredCarriers.filter(c => c && !validCarriers.includes(c));
            
            if (invalidCarriers.length > 0) {
                this.classList.add('is-invalid');
                showValidationTooltip(this, `Invalid carriers: ${invalidCarriers.join(', ')}. Use: tmo, vz, att`);
            } else {
                this.classList.remove('is-invalid');
                hideValidationTooltip(this);
            }
        } else {
            this.classList.remove('is-invalid');
            hideValidationTooltip(this);
        }
    });
    
    // Phone validation
    phone.addEventListener('input', function() {
        const value = this.value.trim();
        if (value) {
            // Remove any non-digit characters for validation
            const digitsOnly = value.replace(/\D/g, '');
            if (digitsOnly.length !== 10) {
                this.classList.add('is-invalid');
                showValidationTooltip(this, 'Enter 10-digit US phone number (e.g., 5551234567)');
            } else {
                // Use our validation function instead of inline regex
                if (!validatePhoneNumber(digitsOnly)) {
                    this.classList.add('is-invalid');
                    showValidationTooltip(this, 'Invalid US phone number format');
                } else {
                    this.classList.remove('is-invalid');
                    hideValidationTooltip(this);
                    // Auto-format the phone number
                    this.value = digitsOnly;
                }
            }
        } else {
            this.classList.remove('is-invalid');
            hideValidationTooltip(this);
        }
    });

    // Load active rentals on page load
    console.log('Loading active rentals on page load...'); // Debug log
    loadActiveRentals();
    
    // Set up polling for SMS updates
    setInterval(checkAllSMS, 5000); // Check every 5 seconds
    
    // Set up real-time wallet balance updates
    updateUserBalance(); // Initial balance load
    setInterval(updateUserBalance, 10000); // Update balance every 10 seconds

    // Add real-time validation for settings inputs
    const areaCodesInput = document.getElementById('areaCodes');
    const carriersInput = document.getElementById('carriers');
    const phoneInput = document.getElementById('phone');
    
    areaCodesInput.addEventListener('blur', function() {
        const value = this.value.trim();
        if (value && !validateAreaCodes(value)) {
            this.classList.add('is-invalid');
            showNotification('Invalid area codes. Use 3-digit codes separated by commas (e.g., 503, 202, 404)', 'warning');
        } else {
            this.classList.remove('is-invalid');
        }
    });
    
    carriersInput.addEventListener('blur', function() {
        const value = this.value.trim();
        if (value && !validateCarriers(value)) {
            this.classList.add('is-invalid');
            showNotification('Invalid carriers. Use: tmo, vz, or att', 'warning');
        } else {
            this.classList.remove('is-invalid');
        }
    });
    
    phoneInput.addEventListener('blur', function() {
        const value = this.value.trim();
        const digitsOnly = value.replace(/\D/g, '');
        if (value && !validatePhoneNumber(digitsOnly)) {
            this.classList.add('is-invalid');
            showNotification('Invalid phone number. Use 10 digits (e.g., 1112223333)', 'warning');
        } else {
            this.classList.remove('is-invalid');
        }
    });

    // Countdown timer simulation
    const countdownTimers = document.querySelectorAll('.countdown-timer');
    
    countdownTimers.forEach(timer => {
        let timeLeft = 4 * 60 + 23; // 4:23 in seconds
        
        const updateTimer = () => {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timer.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeLeft > 0) {
                timeLeft--;
            }
        };
        
        updateTimer();
        setInterval(updateTimer, 1000);
    });
});

// Copy to clipboard function
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        // Create temporary notification
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bs-success);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        `;
        notification.textContent = 'Code copied to clipboard!';
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 2000);
    }).catch(function(err) {
        console.error('Could not copy text: ', err);
    });
}

// Rental management functions
async function rentNumber(serviceCode, ltr = false, autoRenew = false, areaCodes = [], carriers = [], phone = null) {
    console.log('Renting number with params:', { serviceCode, ltr, autoRenew, areaCodes, carriers, phone }); // Debug log
    
    // Validate inputs before making the request
    let hasValidationErrors = false;
    
    if (areaCodes.length > 0) {
        const areaCodesStr = areaCodes.join(',');
        if (!validateAreaCodes(areaCodesStr)) {
            showNotification('Invalid area codes. Use 3-digit codes separated by commas (e.g., 503, 202, 404)', 'error');
            hasValidationErrors = true;
        }
    }
    
    if (carriers.length > 0) {
        const carriersStr = carriers.join(',');
        if (!validateCarriers(carriersStr)) {
            showNotification('Invalid carriers. Use: tmo (T-Mobile), vz (Verizon), or att (AT&T)', 'error');
            hasValidationErrors = true;
        }
    }
    
    if (phone && phone.length > 0 && !validatePhoneNumber(phone)) {
        console.log('Phone validation failed for:', phone, 'Type:', typeof phone, 'Length:', phone.length);
        showNotification('Invalid phone number format. Use a valid 10-digit US number (e.g., 5551234567)', 'error');
        hasValidationErrors = true;
    }
    
    if (hasValidationErrors) {
        return;
    }
    
    try {
        const response = await fetch('/api/rent/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                service_code: serviceCode,
                ltr: ltr,
                auto_renew: autoRenew,
                area_codes: areaCodes,
                carriers: carriers,
                number: phone
            })
        });

        const data = await response.json();
        console.log('Rent API response:', data); // Debug log
        
        if (data.success) {
            showNotification('Number rented successfully!', 'success');
            loadActiveRentals(); // Refresh rentals table
            updateUserBalance(); // Update balance display
        } else {
            // Provide better error messages with helpful suggestions
            let errorMessage = data.error || 'Failed to rent number';
            let errorType = 'error';
            
            console.log('API Error:', errorMessage); // Debug log
            
            // Check for specific error patterns and provide helpful suggestions
            if (errorMessage.includes('service') && errorMessage.includes('not') && errorMessage.includes('support')) {
                errorMessage = 'The "other" service code is not supported by DaisySMS. Contact DaisySMS support to add your requested service, or try a different service.';
                errorType = 'warning';
            } else if (errorMessage.includes('service') && (errorMessage.includes('invalid') || errorMessage.includes('unknown'))) {
                errorMessage = 'Service code not recognized by DaisySMS. This may mean "other" is not available. Try contacting DaisySMS support.';
                errorType = 'warning';
            } else if (errorMessage.includes('area codes') && errorMessage.includes('not available')) {
                errorMessage += ' Try removing area code filters or using common codes like 503, 202, or 404.';
                errorType = 'warning';
            } else if (errorMessage.includes('carriers') && errorMessage.includes('not available')) {
                errorMessage += ' Try removing carrier filters or use: tmo (T-Mobile), vz (Verizon), or att (AT&T).';
                errorType = 'warning';
            } else if (errorMessage.includes('phone number') && errorMessage.includes('not accepted')) {
                errorMessage += ' Some numbers may not be available in the service pool. Try a different number or remove the phone filter.';
                errorType = 'warning';
            } else if (errorMessage.includes('phone number') && errorMessage.includes('not available')) {
                errorMessage += ' This number may be already rented by someone else or temporarily unavailable.';
                errorType = 'warning';
            } else if (errorMessage.includes('Invalid phone number format')) {
                errorMessage += ' Example: 5551234567 (10 digits, no spaces or dashes).';
                errorType = 'warning';
            } else if (errorMessage.includes('Invalid area codes')) {
                errorMessage += ' Use 3-digit US area codes separated by commas (e.g., 503, 202, 404).';
                errorType = 'warning';
            } else if (errorMessage.includes('Invalid carriers')) {
                errorMessage += ' Use carrier codes: tmo, vz, or att.';
                errorType = 'warning';
            } else if (errorMessage.includes('No numbers available')) {
                if (document.getElementById('areaCodes').value.trim() || 
                    document.getElementById('carriers').value.trim() || 
                    document.getElementById('phone').value.trim()) {
                    errorMessage += ' Try clearing your filters (area codes, carriers, or phone) and rent again.';
                    errorType = 'warning';
                }
            }
            
            showNotification(errorMessage, errorType);
        }
    } catch (error) {
        console.error('Error renting number:', error);
        showNotification('Network error occurred', 'error');
    }
}

async function loadActiveRentals() {
    try {
        const response = await fetch('/api/rentals/');
        const data = await response.json();
        
        console.log('Rentals API response:', data); // Debug log
        
        if (data.success && data.rentals) {
            updateRentalsTable(data.rentals);
        } else if (data.rentals) {
            // Handle case where success field might not be present
            updateRentalsTable(data.rentals);
        } else {
            console.error('No rentals data in response:', data);
        }
    } catch (error) {
        console.error('Error loading rentals:', error);
    }
}

function updateRentalsTable(rentals) {
    const tbody = document.querySelector('.table-responsive tbody');
    const rentalCounter = document.getElementById('rentalCounter');
    
    console.log('Updating rentals table with:', rentals); // Debug log
    
    // Filter out cancelled and expired rentals to only show active ones
    const activeRentals = rentals.filter(rental => {
        const createdAt = new Date(rental.created_at);
        const now = new Date();
        const isExpired = (now - createdAt) > (7 * 60 * 1000);
        const isCancelled = rental.status === 'CANCELLED' || rental.status === 'EXPIRED';
        
        // Only show rentals that are still active (not cancelled/expired) or have received code
        return !isCancelled && (!isExpired || rental.code);
    });
    
    // Update counter with active rentals
    if (rentalCounter) {
        rentalCounter.textContent = `${activeRentals.length} / 20`;
    }
    
    if (activeRentals.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-4">
                    <div class="text-muted">
                        <p class="mb-2" style="font-size: 0.9rem;">No rented number yet.</p>
                        <small>Click on a service to rent a number.</small>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = activeRentals.map(rental => {
        // Handle price formatting safely
        let priceDisplay = '‚Ç¶0.00';
        try {
            if (rental.price_naira) {
                const numericPrice = typeof rental.price_naira === 'string' 
                    ? parseFloat(rental.price_naira.replace(/,/g, ''))
                    : parseFloat(rental.price_naira);
                priceDisplay = `‚Ç¶${formatCurrency(numericPrice)}`;
            }
        } catch (e) {
            console.error('Error formatting price:', e);
        }
        
        // Check if rental has received code
        const hasCode = rental.code && rental.code.trim() !== '';
        
        return `
        <tr data-rental-id="${rental.rental_id}" data-supports-multiple="${rental.supports_multiple}">
            <td><span>${rental.rental_id.slice(-6)}</span></td>
            <td>${rental.service_name}</td>
            <td>
                <span class="fw-medium">${rental.phone_number}</span>
                <button class="btn btn-sm ms-1" onclick="copyToClipboard('${rental.phone_number}')">
                    <i class="fas fa-copy"></i>
                </button>
            </td>
            <td class="sms-code" data-rental-id="${rental.rental_id}">
                ${hasCode ? `
                    <span class="text-success">${rental.code}</span>
                    <button class="btn btn-sm ms-1" onclick="copyToClipboard('${rental.code}')">
                        <i class="fas fa-copy"></i>
                    </button>
                ` : '<span class="text-muted">Waiting...</span>'}
            </td>
            <td>${priceDisplay}</td>
            <td class="countdown-timer" data-created="${rental.created_at}" data-has-code="${hasCode}">
                ${hasCode ? '<span class="text-success">‚úÖ</span>' : '420s'}
            </td>
            <td>
                ${rental.status === 'WAITING' && !hasCode ? `
                    <button class="btn btn-sm btn-outline-danger" onclick="cancelRental('${rental.rental_id}')">
                        <i class="fas fa-times"></i>
                    </button>
                ` : ''}
                ${rental.supports_multiple && hasCode ? `
                    <button class="btn btn-sm btn-outline-primary" onclick="checkSMS('${rental.rental_id}')">
                        <i class="fas fa-sync"></i>
                    </button>
                ` : ''}
            </td>
        </tr>
        `;
    }).join('');
    
    // Start countdown timers
    startCountdownTimers();
}

async function cancelRental(rentalId) {
    try {
        const response = await fetch('/api/cancel/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                id: rentalId
            })
        });

        const data = await response.json();
        
        if (data.success) {
            showNotification(`Rental cancelled. Refund: ‚Ç¶${formatCurrency(parseFloat(data.refund_amount) * 1650)}`, 'success');
            
            // Remove the rental row immediately from the table
            const rentalRow = document.querySelector(`tr[data-rental-id="${rentalId}"]`);
            if (rentalRow) {
                rentalRow.remove();
            }
            
            // Update the rental counter
            const rentalCounter = document.getElementById('rentalCounter');
            if (rentalCounter) {
                const currentCount = parseInt(rentalCounter.textContent.split(' / ')[0]);
                rentalCounter.textContent = `${Math.max(0, currentCount - 1)} / 20`;
            }
            
            // Check if table is now empty and show "No rented number yet" message
            const tbody = document.querySelector('.table-responsive tbody');
            if (tbody && tbody.children.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="text-muted">
                                <p class="mb-2" style="font-size: 0.9rem;">No rented number yet.</p>
                                <small>Click on a service to rent a number.</small>
                            </div>
                        </td>
                    </tr>
                `;
            }
            
            updateUserBalance();
        } else {
            showNotification(data.error || 'Failed to cancel rental', 'error');
        }
    } catch (error) {
        console.error('Error cancelling rental:', error);
        showNotification('Network error occurred', 'error');
    }
}

async function checkSMS(rentalId) {
    try {
        const response = await fetch(`/api/sms/${rentalId}/`);
        const data = await response.json();
        
        if (data.messages && data.messages.length > 0) {
            const latestMessage = data.messages[0];
            updateSMSCode(rentalId, latestMessage.code);
        }
    } catch (error) {
        console.error('Error checking SMS:', error);
    }
}

async function checkAllSMS() {
    const rentalRows = document.querySelectorAll('[data-rental-id]');
    
    for (const row of rentalRows) {
        const rentalId = row.getAttribute('data-rental-id');
        const codeCell = row.querySelector('.sms-code');
        const timer = row.querySelector('.countdown-timer');
        
        // Only check if waiting for code and not expired or cancelled
        if (codeCell && codeCell.textContent.includes('Waiting') && timer && !timer.textContent.includes('‚úÖ')) {
            await checkSMS(rentalId);
        }
    }
}

function updateSMSCode(rentalId, code) {
    const codeCell = document.querySelector(`.sms-code[data-rental-id="${rentalId}"]`);
    if (codeCell && code) {
        const row = codeCell.closest('tr');
        const timer = row.querySelector('.countdown-timer');
        
        // Update code cell with ‚úÖ icon and green text
        codeCell.innerHTML = `
            <span class="text-success">‚úÖ ${code}</span>
            <button class="btn btn-sm ms-1" onclick="copyToClipboard('${code}')">
                <i class="fas fa-copy"></i>
            </button>
        `;
        
        // Stop the timer and show "‚úÖ Received"
        if (timer) {
            // Clear the interval if it exists
            const intervalId = timer.getAttribute('data-interval-id');
            if (intervalId) {
                clearInterval(parseInt(intervalId));
            }
            
            timer.innerHTML = '<span class="text-success">‚úÖ</span>';
            timer.setAttribute('data-has-code', 'true');
        }
        
        // Update the actions cell to remove cancel button and add sync button if supported
        const actionsCell = row.querySelector('td:last-child');
        if (actionsCell) {
            // Get rental data to check if supports multiple SMS
            const supportsMultiple = row.getAttribute('data-supports-multiple') === 'true';
            actionsCell.innerHTML = supportsMultiple ? `
                <button class="btn btn-sm btn-outline-primary" onclick="checkSMS('${rentalId}')">
                    <i class="fas fa-sync"></i>
                </button>
            ` : '';
        }
        
        showNotification('SMS code received!', 'success');
    }
}

function startCountdownTimers() {
    const timers = document.querySelectorAll('.countdown-timer');
    
    timers.forEach(timer => {
        // Skip timers that already have codes or are already expired/cancelled
        const hasCode = timer.getAttribute('data-has-code') === 'true';
        if (hasCode || timer.textContent.includes('Cancelled') || timer.textContent.includes('Expired') || timer.textContent.includes('‚úÖ')) {
            return;
        }
        
        const createdAt = new Date(timer.getAttribute('data-created'));
        const endTime = new Date(createdAt.getTime() + 7 * 60 * 1000); // 7 minutes
        
        const updateTimer = () => {
            // Check if timer has been updated to show code received
            if (timer.textContent.includes('‚úÖ') || timer.getAttribute('data-has-code') === 'true') {
                return;
            }
            
            const now = new Date();
            const timeLeft = Math.max(0, endTime - now);
            const totalSeconds = Math.floor(timeLeft / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            
            if (timeLeft <= 0) {
                // Time expired - handle expiration
                handleRentalExpiration(timer);
            } else {
                // Show countdown in seconds only
                timer.textContent = `${totalSeconds}s`;
                if (totalSeconds <= 60) {
                    timer.classList.add('text-warning'); // Show warning when under 1 minute
                }
            }
        };
        
        updateTimer();
        const intervalId = setInterval(updateTimer, 1000);
        
        // Store interval ID on timer element so we can clear it if needed
        timer.setAttribute('data-interval-id', intervalId);
    });
}

async function handleRentalExpiration(timer) {
    const row = timer.closest('tr');
    const rentalId = row.getAttribute('data-rental-id');
    
    // Clear the timer interval
    const intervalId = timer.getAttribute('data-interval-id');
    if (intervalId) {
        clearInterval(parseInt(intervalId));
    }
    
    // Update timer display
    timer.textContent = 'Expired';
    timer.classList.add('text-danger');
    
    try {
        // Call backend to handle expiration and refund
        const response = await fetch('/api/expire/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                id: rentalId
            })
        });

        const data = await response.json();
        
        if (data.success) {
            // Show notification about expiration and refund
            showNotification(`Rental expired. Refund: ‚Ç¶${formatCurrency(parseFloat(data.refund_amount || 0) * 1650)}`, 'info');
            
            // Remove the rental row from the table
            if (row) {
                row.remove();
            }
            
            // Update the rental counter
            const rentalCounter = document.getElementById('rentalCounter');
            if (rentalCounter) {
                const currentCount = parseInt(rentalCounter.textContent.split(' / ')[0]);
                rentalCounter.textContent = `${Math.max(0, currentCount - 1)} / 20`;
            }
            
            // Check if table is now empty and show "No rented number yet" message
            const tbody = document.querySelector('.table-responsive tbody');
            if (tbody && tbody.children.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="text-muted">
                                <p class="mb-2" style="font-size: 0.9rem;">No rented number yet.</p>
                                <small>Click on a service to rent a number.</small>
                            </div>
                        </td>
                    </tr>
                `;
            }
            
            updateUserBalance();
        } else {
            // If backend doesn't handle expiration, just mark as expired in UI
            const codeCell = row.querySelector('.sms-code');
            const actionsCell = row.querySelector('td:last-child');
            
            if (codeCell && codeCell.textContent.includes('Waiting')) {
                codeCell.innerHTML = '<span class="text-danger">Expired</span>';
            }
            
            if (actionsCell) {
                actionsCell.innerHTML = ''; // Remove action buttons
            }
        }
    } catch (error) {
        console.error('Error handling rental expiration:', error);
        // Fallback: just update UI to show expired state
        const codeCell = row.querySelector('.sms-code');
        const actionsCell = row.querySelector('td:last-child');
        
        if (codeCell && codeCell.textContent.includes('Waiting')) {
            codeCell.innerHTML = '<span class="text-danger">Expired</span>';
        }
        
        if (actionsCell) {
            actionsCell.innerHTML = ''; // Remove action buttons
        }
    }
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    
    // Map message types to Bootstrap alert classes
    const alertClass = type === 'error' ? 'danger' : type === 'warning' ? 'warning' : type;
    
    notification.className = `alert alert-${alertClass} alert-dismissible fade show`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        max-width: 400px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        border: none;
    `;
    
    // Add appropriate icon based on type
    let icon = '';
    if (type === 'success') {
        icon = '<i class="fas fa-check-circle me-2"></i>';
    } else if (type === 'error') {
        icon = '<i class="fas fa-exclamation-circle me-2"></i>';
    } else if (type === 'warning') {
        icon = '<i class="fas fa-exclamation-triangle me-2"></i>';
    } else {
        icon = '<i class="fas fa-info-circle me-2"></i>';
    }
    
    notification.innerHTML = `
        <div class="d-flex align-items-start">
            <div class="flex-shrink-0">
                ${icon}
            </div>
            <div class="flex-grow-1">
                ${message}
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" style="font-size: 0.8rem;"></button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-dismiss after longer time for warnings and errors
    const dismissTime = (type === 'warning' || type === 'error') ? 8000 : 5000;
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, dismissTime);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function formatCurrency(amount) {
    /**
     * Format number with commas and 2 decimal places
     */
    try {
        return parseFloat(amount).toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    } catch (e) {
        return '0.00';
    }
}

// Real-time wallet balance update
async function updateUserBalance() {
    try {
        const response = await fetch('/api/balance/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            console.error('Failed to fetch balance:', response.status);
            return;
        }
        
        const data = await response.json();
        
        if (data.success && data.balance_naira) {
            // Remove commas from the API response before parsing
            const balanceValue = data.balance_naira.replace(/,/g, '');
            const numericBalance = parseFloat(balanceValue);
            
            // Update desktop balance display
            const desktopBalanceElement = document.querySelector('.navbar-right .balance-amount');
            if (desktopBalanceElement) {
                desktopBalanceElement.textContent = `‚Ç¶${formatCurrency(numericBalance)}`;
            }
            
            // Update mobile balance display
            const mobileBalanceElement = document.querySelector('.mobile-user-info .user-balance');
            if (mobileBalanceElement) {
                mobileBalanceElement.textContent = `Balance: ‚Ç¶${formatCurrency(numericBalance)}`;
            }
        }
    } catch (error) {
        console.error('Error updating balance:', error);
    }
}

// Favorite services management
function loadFavorites() {
    const favorites = JSON.parse(localStorage.getItem('favoriteServices') || '[]');
    
    favorites.forEach(serviceCode => {
        const row = document.querySelector(`[data-code="${serviceCode}"]`);
        if (row) {
            const favoriteBtn = row.querySelector('.favorite-btn');
            const heartIcon = favoriteBtn.querySelector('span');
            
            favoriteBtn.setAttribute('data-favorite', 'true');
            heartIcon.textContent = '‚ô•';
            heartIcon.className = 'text-danger';
        }
    });
    
    // Sort services after loading favorites
    sortServicesByFavorites();
}

function addFavorite(serviceCode) {
    const favorites = JSON.parse(localStorage.getItem('favoriteServices') || '[]');
    if (!favorites.includes(serviceCode)) {
        favorites.push(serviceCode);
        localStorage.setItem('favoriteServices', JSON.stringify(favorites));
    }
}

function removeFavorite(serviceCode) {
    const favorites = JSON.parse(localStorage.getItem('favoriteServices') || '[]');
    const index = favorites.indexOf(serviceCode);
    if (index > -1) {
        favorites.splice(index, 1);
        localStorage.setItem('favoriteServices', JSON.stringify(favorites));
    }
}

function sortServicesByFavorites() {
    const tbody = document.querySelector('.table.table-hover.mb-0.table-sm tbody');
    if (!tbody) return;
    
    const rows = Array.from(tbody.querySelectorAll('.service-row'));
    
    // Sort rows: favorites first, then alphabetically
    rows.sort((a, b) => {
        const aIsFavorite = a.querySelector('.favorite-btn').getAttribute('data-favorite') === 'true';
        const bIsFavorite = b.querySelector('.favorite-btn').getAttribute('data-favorite') === 'true';
        
        // If both are favorites or both are not favorites, sort alphabetically
        if (aIsFavorite === bIsFavorite) {
            const aName = a.getAttribute('data-service').toLowerCase();
            const bName = b.getAttribute('data-service').toLowerCase();
            return aName.localeCompare(bName);
        }
        
        // Favorites come first
        return bIsFavorite - aIsFavorite;
    });
    
    // Re-append rows in sorted order
    rows.forEach(row => tbody.appendChild(row));
}

// Validation tooltip functions
function showValidationTooltip(element, message) {
    hideValidationTooltip(element); // Remove any existing tooltip
    
    const tooltip = document.createElement('div');
    tooltip.className = 'validation-tooltip';
    tooltip.textContent = message;
    tooltip.style.cssText = `
        position: absolute;
        background: #dc3545;
        color: white;
        padding: 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        z-index: 1000;
        max-width: 200px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        top: 100%;
        left: 0;
        margin-top: 0.25rem;
    `;
    
    const container = element.closest('.input-group');
    container.style.position = 'relative';
    container.appendChild(tooltip);
    
    // Store reference for cleanup
    element._validationTooltip = tooltip;
}

function hideValidationTooltip(element) {
    if (element._validationTooltip) {
        element._validationTooltip.remove();
        element._validationTooltip = null;
    }
}

// Helper functions for clearing settings
function clearAreaCodes() {
    document.getElementById('areaCodes').value = '';
    showNotification('Area codes cleared', 'info');
}

function clearCarriers() {
    document.getElementById('carriers').value = '';
    showNotification('Carriers cleared', 'info');
}

function clearPhone() {
    document.getElementById('phone').value = '';
    showNotification('Phone number cleared', 'info');
}

function clearAllFilters() {
    document.getElementById('areaCodes').value = '';
    document.getElementById('carriers').value = '';
    document.getElementById('phone').value = '';
    
    // Remove any validation classes
    document.getElementById('areaCodes').classList.remove('is-invalid');
    document.getElementById('carriers').classList.remove('is-invalid');
    document.getElementById('phone').classList.remove('is-invalid');
    
    showNotification('All filters cleared', 'success');
}

// Input validation for settings
function validateAreaCodes(input) {
    const areaCodes = input.split(',').map(code => code.trim()).filter(code => code);
    const validCodes = areaCodes.filter(code => /^\d{3}$/.test(code));
    
    if (areaCodes.length !== validCodes.length) {
        return false;
    }
    return true;
}

function validateCarriers(input) {
    const carriers = input.split(',').map(carrier => carrier.trim().toLowerCase()).filter(carrier => carrier);
    const validCarriers = ['tmo', 'vz', 'att'];
    
    return carriers.every(carrier => validCarriers.includes(carrier));
}

function validatePhoneNumber(input) {
    console.log('Validating phone number input:', input, 'Type:', typeof input);
    
    if (!input) {
        console.log('Phone validation: input is empty');
        return true; // Empty is valid (optional field)
    }
    
    const digitsOnly = input.replace(/\D/g, '');
    console.log('Digits only:', digitsOnly, 'Length:', digitsOnly.length);
    
    // Must be exactly 10 digits
    if (digitsOnly.length !== 10) {
        console.log('Phone validation failed: length is not 10');
        return false;
    }
    
    // Basic validation: cannot start with 0 or 1, cannot be all same digits
    if (digitsOnly.charAt(0) === '0' || digitsOnly.charAt(0) === '1') {
        console.log('Phone validation failed: starts with 0 or 1');
        return false;
    }
    
    // Reject obviously invalid numbers (all same digit, etc.)
    if (/^(\d)\1{9}$/.test(digitsOnly)) {
        console.log('Phone validation failed: all same digits');
        return false;
    }
    
    console.log('Phone validation passed');
    return true;
}

// Debug function for testing phone validation
function testPhoneValidation(phoneNumber) {
    console.log('Testing phone number:', phoneNumber);
    const result = validatePhoneNumber(phoneNumber);
    console.log('Validation result:', result);
    return result;
}

// Handle "service not listed" option
function handleServiceNotListed(searchTerm, hasVisibleServices) {
    const tbody = document.querySelector('.table.table-hover.mb-0.table-sm tbody');
    let serviceNotListedRow = document.getElementById('service-not-listed-row');
    
    // Remove existing "service not listed" row if it exists
    if (serviceNotListedRow) {
        serviceNotListedRow.remove();
    }
    
    // Only show "service not listed" if there's a search term and no visible services
    if (searchTerm.trim() && !hasVisibleServices) {
        // Create "service not listed" row
        serviceNotListedRow = document.createElement('tr');
        serviceNotListedRow.id = 'service-not-listed-row';
        serviceNotListedRow.className = 'service-row';
        serviceNotListedRow.setAttribute('data-service', 'Service Not Listed');
        serviceNotListedRow.setAttribute('data-code', 'service_not_listed');
        
        serviceNotListedRow.innerHTML = `
            <td class="service-name">
                <div class="fw-medium" style="font-size: 0.85rem;">
                    <i class="fas fa-plus-circle me-2 text-primary"></i>Service Not Listed
                </div>
            </td>
            <td class="price">
                <div class="fw-medium" style="font-size: 0.85rem;" id="service-not-listed-price">Loading...</div>
            </td>
            <td class="text-center">
                <button class="btn btn-link p-0 favorite-btn" data-favorite="false">
                    <span class="text-muted">‚ô°</span>
                </button>
            </td>
        `;
        
        // Add click handler for service not listed
        serviceNotListedRow.addEventListener('click', function(e) {
            if (e.target.closest('.favorite-btn')) {
                return;
            }
            
            const serviceName = 'Service Not Listed';
            const serviceCode = 'service_not_listed';
            
            // Get settings values
            const areaCodes = document.getElementById('areaCodes').value.split(',').map(code => code.trim()).filter(code => code);
            const carriers = document.getElementById('carriers').value.split(',').map(carrier => carrier.trim()).filter(carrier => carrier);
            const phoneRaw = document.getElementById('phone').value.trim();
            const phone = phoneRaw ? phoneRaw.replace(/\D/g, '') : null;
            
            console.log('Renting service not listed:', { serviceCode, areaCodes, carriers, phone });
            rentNumber(serviceCode, false, false, areaCodes, carriers, phone);
        });
        
        // Insert at the beginning of tbody
        tbody.insertBefore(serviceNotListedRow, tbody.firstChild);
        
        // Fetch and display the price for "service not listed"
        fetchServiceNotListedPrice();
    }
}

// Fetch price for "Service Not Listed" from backend
async function fetchServiceNotListedPrice() {
    try {
        const response = await fetch('/api/services/');
        const data = await response.json();
        
        console.log('Services API response:', data); // Debug log
        
        if (data.services) {
            const serviceNotListed = data.services.find(service => 
                service.name === 'Service Not Listed' || service.code === 'service_not_listed'
            );
            
            console.log('Found Service Not Listed:', serviceNotListed); // Debug log
            
            if (serviceNotListed) {
                const priceElement = document.getElementById('service-not-listed-price');
                if (priceElement) {
                    // The price_naira is already formatted, so use it directly
                    priceElement.textContent = `‚Ç¶${serviceNotListed.price_naira}`;
                }
            } else {
                console.warn('Service Not Listed not found in services list');
                // Fallback: try to create the service
                await createServiceNotListed();
            }
        } else {
            console.error('No services data in API response');
        }
    } catch (error) {
        console.error('Error fetching service not listed price:', error);
        const priceElement = document.getElementById('service-not-listed-price');
        if (priceElement) {
            priceElement.textContent = 'Error loading price'; // Show error instead of fallback
            priceElement.style.color = '#dc3545'; // Error color
        }
    }
}

// Create Service Not Listed if it doesn't exist
async function createServiceNotListed() {
    try {
        console.log('Attempting to create Service Not Listed...');
        
        const response = await fetch('/api/create-service-not-listed/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            console.log('Service Not Listed created/exists:', data.service);
            
            // Update the price element
            const priceElement = document.getElementById('service-not-listed-price');
            if (priceElement && data.service) {
                // The price_naira is already formatted, so use it directly
                priceElement.textContent = `‚Ç¶${data.service.price_naira}`;
                priceElement.style.color = ''; // Remove warning color
                priceElement.title = '';
            }
            
            if (data.message.includes('created')) {
                showNotification('Service Not Listed has been set up successfully!', 'success');
            }
        } else {
            console.error('Failed to create Service Not Listed:', data);
            const priceElement = document.getElementById('service-not-listed-price');
            if (priceElement) {
                priceElement.textContent = 'Admin setup required'; // Show setup message instead of fallback
                priceElement.style.color = '#ffc107'; // Warning color
                priceElement.title = 'Service needs admin setup';
            }
            
            showNotification('Please contact administrator to set up "Service Not Listed" in Django Admin.', 'warning');
        }
    } catch (error) {
        console.error('Error creating service not listed:', error);
        const priceElement = document.getElementById('service-not-listed-price');
        if (priceElement) {
            priceElement.textContent = 'Error loading price'; // Show error instead of fallback
            priceElement.style.color = '#dc3545'; // Error color
            priceElement.title = 'Service needs admin setup';
        }
    }
}

// Fetch real-time prices from DaisySMS API (optional feature)
async function fetchRealtimePrices() {
    try {
        const response = await fetch('/api/realtime-prices/');
        const data = await response.json();
        
        if (data.success && data.realtime_prices) {
            console.log('Real-time prices from DaisySMS:', data.realtime_prices);
            
            // Update service availability based on real-time data
            const serviceRows = document.querySelectorAll('.service-row');
            serviceRows.forEach(row => {
                const serviceCode = row.getAttribute('data-code');
                if (serviceCode && data.realtime_prices[serviceCode]) {
                    const realtimeData = data.realtime_prices[serviceCode];
                    const availabilityElement = row.querySelector('.availability-count');
                    if (availabilityElement) {
                        availabilityElement.textContent = `${realtimeData.count} available`;
                    }
                }
            });
        }
    } catch (error) {
        console.error('Error fetching real-time prices:', error);
    }
}

// Auto-sync prices every 30 seconds (optional)
function enableAutoSync() {
    // Fetch real-time data on page load
    fetchRealtimePrices();
    
    // Set up periodic sync every 30 seconds
    setInterval(() => {
        fetchRealtimePrices();
    }, 30000);
}

enableAutoSync();
</script>
{% endblock %}
