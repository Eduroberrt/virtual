{% extends 'main.html' %}
{% load static %}
{% load currency_filters %}

{% block title %}Dashboard - Young PG Virtual{% endblock %}

{% block content %}
{% csrf_token %}

<!-- Modern Dashboard Layout -->
<div class="modern-dashboard">
    <!-- Main Content Area -->
    <div class="container-fluid">
        <div class="row g-4">
            <!-- Service Selection Panel -->
            <div class="col-xl-5">
                <div class="service-panel glass-card">
                    <div class="card-header">
                        <h5 class="card-title fw-bold mb-0">
                            SMS Verification
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <p class="text-muted mb-4 small">
                            Rent a phone for up to 15 minutes.<br>
                            Credits are only used if you receive the SMS code.
                        </p>
                        
                        <!-- Modern Form Controls -->
                        <div class="form-stack">
                            <div class="form-group">
                                <label class="modern-label">
                                    <i class="fas fa-flag me-2"></i>Country
                                </label>
                                <div class="modern-select-wrapper">
                                    <select class="modern-select" id="countrySelect">
                                        <option value="">Choose your country...</option>
                                    </select>
                                    <i class="fas fa-chevron-down select-arrow"></i>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="modern-label">
                                    <i class="fas fa-apps me-2"></i>Service
                                </label>
                                <div class="modern-select-wrapper">
                                    <select class="modern-select" id="productSelect">
                                        <option value="">Select country first</option>
                                    </select>
                                    <i class="fas fa-chevron-down select-arrow"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Service Info Panel -->
                        <div id="serviceInfoPanel" class="service-info-panel" style="display: none;">
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">Country</span>
                                    <span class="info-value" id="selectedCountry">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Service</span>
                                    <span class="info-value" id="selectedProduct">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Operator</span>
                                    <span class="info-value" id="selectedOperator">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Price</span>
                                    <span class="info-value text-success fw-bold" id="selectedPrice">-</span>
                                </div>
                            </div>
                            
                            <!-- Purchase Button -->
                            <button class="btn btn-primary btn-lg w-100 purchase-btn" id="purchaseBtn">
                                <i class="fas fa-shopping-cart me-2"></i>Purchase SMS Number
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Orders Panel -->
            <div class="col-xl-7">
                <div id="recentOrdersPanel" class="orders-panel glass-card">
                    <div class="card-header">
                        <h5 class="card-title fw-bold mb-0">
                            Recent Orders
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <p class="text-muted px-4 pt-3 mb-3 small">Monitor your orders in real-time. No need to refresh the page.</p>
                        
                        <div class="orders-container">
                            <div class="modern-table-wrapper">
                                <table class="modern-table" id="ordersTable">
                                    <thead>
                                        <tr>
                                            <th>Service</th>
                                            <th>Country</th>
                                            <th>Number</th>
                                            <th>TTL</th>
                                            <th>Code</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ordersTableBody">
                                        <tr id="noOrdersRow" class="no-orders-row">
                                            <td colspan="5">
                                                <div class="empty-state">
                                                    <i class="fas fa-inbox"></i>
                                                    <h6 class="mb-1">No orders yet</h6>
                                                    <p class="text-muted small mb-0">Your orders will appear here once you make a purchase.</p>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden operators table -->
<table class="d-none" id="operatorsTable">
    <tbody id="operatorsTableBody"></tbody>
</table>

<!-- Modern CSS Styles -->
<style>
:root {
    --primary-color: #198754;
    --secondary-color: #6c757d;
    --success-color: #28a745;
    --info-color: #17a2b8;
    --warning-color: #ffc107;
    --danger-color: #dc3545;
    --light-color: #f8f9fa;
    --dark-color: #212529;
    --border-radius: 16px;
    --border-radius-sm: 8px;
    --border-radius-lg: 24px;
    --shadow-sm: 0 2px 8px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 20px rgba(0,0,0,0.08);
    --shadow-lg: 0 8px 40px rgba(0,0,0,0.12);
    --gradient-primary: linear-gradient(135deg, #198754 0%, #20c997 100%);
    --gradient-secondary: linear-gradient(135deg, #6c757d 0%, #adb5bd 100%);
}

/* Modern Dashboard Layout */
.modern-dashboard {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    min-height: 100vh;
    padding: 1rem 0 0.1rem 0;
}

.hero-section {
    margin-bottom: 2rem;
}

/* Glass Card Effect */
.glass-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(25, 135, 84, 0.15);
    border-radius: var(--border-radius);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.glass-card:hover {
    transform: translateY(-2px);
    border-color: rgba(25, 135, 84, 0.25);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
}

.glass-card .card-header {
    background: linear-gradient(135deg, rgba(25, 135, 84, 0.08) 0%, rgba(32, 201, 151, 0.08) 100%);
    border-bottom: 1px solid rgba(25, 135, 84, 0.1);
    border-radius: calc(var(--border-radius) - 2px) calc(var(--border-radius) - 2px) 0 0;
    padding: 1.25rem 1.5rem;
}

.glass-card .card-body {
    border-radius: 0 0 calc(var(--border-radius) - 2px) calc(var(--border-radius) - 2px);
}

/* Override glass card for specific panels */
.orders-panel.glass-card .card-body,
.service-panel.glass-card .card-body {
    border-radius: 0 0 var(--border-radius) var(--border-radius);
    overflow: hidden;
}

/* Panel Layout */
.service-panel,
.orders-panel {
    display: flex;
    flex-direction: column;
}

.service-panel .card-body,
.orders-panel .card-body {
    flex: 1;
}

.orders-container {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.modern-table-wrapper {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.modern-table {
    flex: 1;
}

.no-orders-row {
    height: 200px;
}

/* Welcome Card */
.welcome-card {
    background: var(--gradient-primary);
    color: white;
    overflow: hidden;
    position: relative;
}

.welcome-card::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -10%;
    width: 200px;
    height: 200px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    transform: rotate(45deg);
}

.hero-icon {
    font-size: 3rem;
    opacity: 0.3;
    position: absolute;
    top: 1rem;
    right: 1rem;
}

.feature-pills {
    gap: 0.5rem;
}

.pill {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 500;
    backdrop-filter: blur(10px);
}

.pill-primary { background: rgba(255, 255, 255, 0.2); }
.pill-success { background: rgba(255, 255, 255, 0.15); }
.pill-info { background: rgba(255, 255, 255, 0.1); }

/* Balance Card */
.balance-card {
    text-align: center;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border: 2px solid rgba(25, 135, 84, 0.1);
}

.balance-icon {
    width: 60px;
    height: 60px;
    background: var(--gradient-primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    color: white;
    font-size: 1.5rem;
}

.balance-card .balance-amount {
    font-size: 1.8rem;
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

/* Service Panel */
.service-panel .card-header {
    background: var(--primary-color);
    color: white;
    border-radius: var(--border-radius) var(--border-radius) 0 0;
    padding: 1rem 1.5rem;
    border: none;
}

/* Modern Form Controls */
.form-stack {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.form-group {
    position: relative;
}

.modern-label {
    display: block;
    font-weight: 600;
    color: var(--dark-color);
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

.modern-select-wrapper {
    position: relative;
}

.modern-select {
    width: 100%;
    padding: 0.875rem 1rem;
    border: 2px solid #e9ecef;
    border-radius: var(--border-radius-sm);
    background: white;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    appearance: none;
    cursor: pointer;
}

.modern-select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(25, 135, 84, 0.1);
}

.modern-select:hover {
    border-color: #ced4da;
}

.select-arrow {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--secondary-color);
    pointer-events: none;
    transition: transform 0.3s ease;
}

.modern-select:focus + .select-arrow {
    transform: translateY(-50%) rotate(180deg);
}

/* Service Info Panel */
.service-info-panel {
    margin-top: 2rem;
    padding: 1.5rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: var(--border-radius);
    border: 1px solid #dee2e6;
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.info-label {
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--secondary-color);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.info-value {
    font-weight: 600;
    color: var(--dark-color);
}

/* Purchase Button */
.purchase-btn {
    background: var(--gradient-primary);
    border: none;
    border-radius: var(--border-radius-sm);
    padding: 0.875rem 1.5rem;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.purchase-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s ease;
}

.purchase-btn:hover::before {
    left: 100%;
}

.purchase-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

/* Orders Panel */
.orders-panel .card-header {
    background: var(--primary-color);
    color: white;
    border-radius: var(--border-radius) var(--border-radius) 0 0;
    padding: 1rem 1.5rem;
    border: none;
}

.orders-container {
    max-height: 500px;
    overflow-y: auto;
}

/* Modern Table */
.modern-table-wrapper {
    overflow-x: auto;
}

.modern-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: inherit;
    overflow: hidden;
}

.modern-table thead th {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    color: var(--dark-color);
    font-weight: 600;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 1rem 0.75rem;
    border-bottom: 2px solid #dee2e6;
    position: sticky;
    top: 0;
    z-index: 10;
}

.modern-table tbody td {
    padding: 1rem 0.75rem;
    border-bottom: 1px solid #f1f3f4;
    vertical-align: middle;
    font-size: 0.9rem;
}

.modern-table tbody tr {
    transition: all 0.2s ease;
}

.modern-table tbody tr:hover {
    background: rgba(25, 135, 84, 0.02);
}

/* Ensure last row respects border radius */
.modern-table tbody tr:last-child td:first-child {
    border-bottom-left-radius: var(--border-radius);
}

.modern-table tbody tr:last-child td:last-child {
    border-bottom-right-radius: var(--border-radius);
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--secondary-color);
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

/* Badges and Pills */
.badge {
    border-radius: 20px;
    padding: 0.35rem 0.75rem;
    font-weight: 500;
    font-size: 0.75rem;
}

/* Gradient Button */
.btn-gradient {
    background: var(--gradient-primary);
    border: none;
    color: white;
    transition: all 0.3s ease;
}

.btn-gradient:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-sm);
    color: white;
}

/* Custom Scrollbar */
.orders-container::-webkit-scrollbar {
    width: 4px;
}

.orders-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 2px;
}

.orders-container::-webkit-scrollbar-thumb {
    background: var(--primary-color);
    border-radius: 2px;
}

.orders-container::-webkit-scrollbar-thumb:hover {
    background: #157347;
}

/* Responsive Design */
@media (max-width: 768px) {
    .modern-dashboard {
        padding: 1rem 0;
    }
    
    .info-grid {
        grid-template-columns: 1fr;
    }
    
    .hero-icon {
        display: none;
    }
    
    .feature-pills {
        justify-content: center;
    }
    
    .balance-card .balance-amount {
        font-size: 1.5rem;
    }
    
    /* Keep cancel button inline with TTL countdown on mobile */
    .countdown-timer {
        display: inline-block;
        margin-right: 0.25rem;
    }
    
    .btn-link.text-danger {
        display: inline-block;
        margin-left: 0.25rem;
        vertical-align: middle;
    }
}

/* Animation Classes */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.fade-in-up {
    animation: fadeInUp 0.6s ease forwards;
}

/* Loading States */
.btn:disabled {
    opacity: 0.7;
    transform: none !important;
}

.spinner-border-sm {
    width: 1rem;
    height: 1rem;
}

/* Toast Improvements */
.toast {
    border-radius: var(--border-radius-sm);
    box-shadow: var(--shadow-md);
    backdrop-filter: blur(10px);
}

/* Status Indicators */
.status-active { color: var(--success-color); }
.status-pending { color: var(--warning-color); }
.status-cancelled { color: var(--secondary-color); }
.status-completed { color: var(--info-color); }

/* Action Buttons */
.action-btn {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    border: none;
    transition: all 0.2s ease;
}

.action-btn:hover {
    transform: scale(1.1);
}

.action-btn-danger {
    background: rgba(220, 53, 69, 0.1);
    color: var(--danger-color);
}

.action-btn-danger:hover {
    background: var(--danger-color);
    color: white;
}

/* Cancel Button in TTL Column */
.btn-link.text-danger {
    padding: 0.2rem 0.4rem;
    font-size: 0.8rem;
    border-radius: 4px;
    text-decoration: none;
    transition: all 0.2s ease;
    background: rgba(220, 53, 69, 0.1);
    border: 1px solid rgba(220, 53, 69, 0.2);
}

.btn-link.text-danger:hover {
    background: rgba(220, 53, 69, 0.15);
    transform: scale(1.05);
    text-decoration: none;
}

/* Z-index fix to prevent dropdown from going behind cards */
.glass-card {
    position: relative;
    z-index: 1;
}

.service-panel {
    z-index: 1;
}

.orders-panel {
    z-index: 1;
}

/* WORKING Dark mode styles - copied from dashboard-2 pattern */
[data-theme="dark"] .glass-card {
    background-color: #000000 !important;
    border-color: #404040 !important;
    color: #ffffff !important;
}

[data-theme="dark"] .glass-card .card-header {
    background-color: #000000 !important;
    color: #ffffff !important;
    border-bottom-color: #404040 !important;
}

[data-theme="dark"] .glass-card .card-body {
    background-color: #000000 !important;
    color: #ffffff !important;
}

[data-theme="dark"] .glass-card .card-title {
    color: #ffffff !important;
}

[data-theme="dark"] .glass-card p {
    color: #ffffff !important;
}

[data-theme="dark"] .glass-card .text-muted {
    color: #b3b3b3 !important;
}

[data-theme="dark"] .glass-card .small {
    color: #b3b3b3 !important;
}

/* Modern form controls dark mode */
[data-theme="dark"] .modern-label {
    color: #ffffff !important;
}

[data-theme="dark"] .modern-select {
    background-color: #000000 !important;
    color: #ffffff !important;
    border-color: #404040 !important;
}

[data-theme="dark"] .modern-select option {
    background-color: #000000 !important;
    color: #ffffff !important;
}

[data-theme="dark"] .select-arrow {
    color: #ffffff !important;
}

/* Modern table dark mode - exact copy of dashboard-2 working pattern */
[data-theme="dark"] .modern-table {
    background-color: #000000 !important;
    color: #ffffff !important;
}

[data-theme="dark"] .modern-table th {
    background-color: #000000 !important;
    color: #ffffff !important;
    border-color: #404040 !important;
}

[data-theme="dark"] .modern-table td {
    background-color: #000000 !important;
    color: #ffffff !important;
    border-color: #404040 !important;
}

[data-theme="dark"] .modern-table tbody tr {
    background-color: #000000 !important;
    color: #ffffff !important;
}

[data-theme="dark"] .modern-table tbody tr:hover {
    background-color: #1a1a1a !important;
    color: #ffffff !important;
}

[data-theme="dark"] .modern-table-wrapper {
    background-color: #000000 !important;
}

/* Empty state dark mode */
[data-theme="dark"] .empty-state {
    color: #ffffff !important;
}

[data-theme="dark"] .empty-state h6 {
    color: #ffffff !important;
}

[data-theme="dark"] .empty-state p {
    color: #b3b3b3 !important;
}

[data-theme="dark"] .empty-state i {
    color: #b3b3b3 !important;
}

/* Service info panel dark mode */
[data-theme="dark"] .service-info-panel {
    background-color: #000000 !important;
    color: #ffffff !important;
}

[data-theme="dark"] .info-label {
    color: #b3b3b3 !important;
}

[data-theme="dark"] .info-value {
    color: #ffffff !important;
}
</style>

<script>
console.log('üü¢ Modern Dashboard JavaScript loaded');

class SMSDashboard {
    constructor() {
        console.log('üèóÔ∏è SMSDashboard constructor called');
        this.countries = {};
        this.products = {};
        this.currentPrices = {};
        this.selectedService = {};
        this.orderTimerInterval = null;
        this.smsCheckInterval = null;
        
        this.init();
    }
    
    async init() {
        await this.loadCountries();
        await this.loadProducts();
        this.bindEvents();
        this.loadRecentOrders(); // Load orders on page load
    }
    
    async loadCountries() {
        try {
            const response = await fetch('/api/5sim/countries/');
            const data = await response.json();
            
            if (data.success && data.countries) {
                this.countries = data.countries;
                this.populateCountrySelect();
            } else {
                this.countries = {};
                this.populateCountrySelect();
                this.showError(data.error || 'Failed to load countries');
            }
        } catch (error) {
            console.error('Failed to load countries:', error);
            this.countries = {};
            this.populateCountrySelect();
            this.showError('Failed to load countries');
        }
    }
    
    async loadProducts() {
        try {
            const response = await fetch('/api/5sim/products-list/');
            const data = await response.json();
            
            if (data.success && data.products) {
                this.products = data.products;
            } else {
                this.products = {};
                this.showError(data.error || 'Failed to load products');
            }
        } catch (error) {
            console.error('Failed to load products:', error);
            this.products = {};
            this.showError('Failed to load products');
        }
    }
    
    populateCountrySelect() {
        const select = document.getElementById('countrySelect');
        select.innerHTML = '<option value="">Select Country</option>';
        
        Object.entries(this.countries).forEach(([code, name]) => {
            const option = document.createElement('option');
            option.value = code;
            option.textContent = name;
            select.appendChild(option);
        });
    }
    
    populateProductSelect(country) {
        const select = document.getElementById('productSelect');
        select.innerHTML = '<option value="">Select Product</option>';
        
        // Sort products alphabetically by name
        const sortedProducts = Object.entries(this.products).sort(([codeA, nameA], [codeB, nameB]) => {
            return nameA.localeCompare(nameB);
        });
        
        sortedProducts.forEach(([code, name]) => {
            const option = document.createElement('option');
            option.value = code;
            option.textContent = name;
            select.appendChild(option);
        });
    }
    
    async loadOperators(country, product) {
        if (!country || !product) {
            // Hide operators section when no selection
            document.getElementById('operatorsTable').style.display = 'none';
            this.selectedService = null;
            return;
        }

        try {
            const response = await fetch(`/api/5sim/prices/${country}/${product}/`);
            const data = await response.json();
            
            if (data.success && data.prices) {
                this.currentPrices = data.prices;
                // Auto-select cheapest operator instead of showing table
                this.autoSelectCheapestOperator(country, product, data.prices);
            } else {
                this.showError('No pricing data available');
            }
        } catch (error) {
            console.error('Failed to load operators:', error);
            this.showError('Failed to load pricing data');
        }
    }
    
    autoSelectCheapestOperator(country, product, prices) {
        if (!prices || Object.keys(prices).length === 0) {
            this.showError('No operators available for this selection');
            return;
        }
        
        // Find the cheapest operator with available numbers
        let cheapestOperator = null;
        let cheapestPrice = Infinity;
        
        Object.entries(prices).forEach(([operator, data]) => {
            if (data.count > 0 && data.cost < cheapestPrice) {
                cheapestPrice = data.cost;
                cheapestOperator = {
                    name: operator,
                    cost: data.cost,
                    count: data.count
                };
            }
        });
        
        if (cheapestOperator) {
            // Auto-select the cheapest operator
            this.selectOperator(cheapestOperator.name, cheapestOperator.cost, cheapestOperator.count);
            
            // Hide the operators table since we auto-selected
            document.getElementById('operatorsTable').style.display = 'none';
            
            console.log(`üéØ Auto-selected operator: ${cheapestOperator.name} with price ‚Ç¶${cheapestOperator.cost}`);
        } else {
            this.showError('No operators with available numbers for this selection');
        }
    }
    
    displayOperators(prices) {
        const tbody = document.getElementById('operatorsTableBody');
        tbody.innerHTML = '';
        
        if (!prices || Object.keys(prices).length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-muted py-3">
                        No operators available for this selection
                    </td>
                </tr>
            `;
            return;
        }
        
        Object.entries(prices).forEach(([operator, data]) => {
            const row = document.createElement('tr');
            row.style.cursor = 'pointer';
            
            // Disable button if count is 0
            const isDisabled = data.count === 0;
            const buttonClass = isDisabled ? 'btn btn-sm btn-outline-secondary disabled' : 'btn btn-sm btn-outline-success';
            const onClick = isDisabled ? '' : `onclick="dashboard.selectOperator('${operator}', ${data.cost}, ${data.count})"`;
            
            row.innerHTML = `
                <td class="fw-medium">${operator}</td>
                <td class="text-end fw-bold text-success">‚Ç¶${data.cost}</td>
                <td class="text-center">
                    <span class="badge ${data.count > 0 ? 'bg-light text-dark' : 'bg-danger text-white'}">${data.count}</span>
                </td>
                <td class="text-end" style="width: 80px;">
                    <button class="${buttonClass}" ${onClick} style="width: 65px; padding: 0.25rem 0.5rem;">
                        Select
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }
    
    selectOperator(operator, cost, count) {
        const country = document.getElementById('countrySelect').value;
        const product = document.getElementById('productSelect').value;
        
        this.selectedService = {
            country: this.countries[country],
            countryCode: country,
            product: this.products[product],
            productCode: product,
            operator: operator,
            cost: cost,
            count: count
        };
        
        this.updateServicePanel();
    }
    
    updateServicePanel() {
        document.getElementById('selectedCountry').textContent = this.selectedService.country;
        document.getElementById('selectedProduct').textContent = this.selectedService.product;
        document.getElementById('selectedOperator').textContent = `${this.selectedService.operator} üéØ`;
        document.getElementById('selectedPrice').textContent = `‚Ç¶${this.selectedService.cost}`;
        
        document.getElementById('serviceInfoPanel').style.display = 'block';
        
        this.updateTotalPrice();
    }
    
    updateTotalPrice() {
        const quantityInput = document.getElementById('quantityInput');
        const totalPriceElement = document.getElementById('totalPrice');
        
        if (!quantityInput || !totalPriceElement) {
            console.warn('‚ö†Ô∏è Quantity input or total price element not found');
            return;
        }
        
        const quantity = parseInt(quantityInput.value) || 1;
        const total = this.selectedService.cost * quantity;
        totalPriceElement.value = `‚Ç¶${total}`;
    }
    
    showError(message) {
        // Show toast or alert
        console.error(message);
    }
    
    bindEvents() {
        console.log('üîó Binding events...');
        
        // Check if purchase button exists
        const purchaseBtn = document.getElementById('purchaseBtn');
        console.log('üîç Purchase button found:', purchaseBtn);
        
        if (!purchaseBtn) {
            console.error('‚ùå Purchase button not found in DOM!');
            return;
        }
        
        document.getElementById('countrySelect').addEventListener('change', (e) => {
            const country = e.target.value;
            if (country) {
                this.populateProductSelect(country);
                // Reset product selection
                const productSelect = document.getElementById('productSelect');
                if (productSelect) productSelect.value = '';
                // Reset selected service
                this.selectedService = null;
            }
        });
        
        const productSelect = document.getElementById('productSelect');
        if (productSelect) {
            productSelect.addEventListener('change', (e) => {
                const product = e.target.value;
                const countrySelect = document.getElementById('countrySelect');
                const country = countrySelect ? countrySelect.value : null;
                if (country && product) {
                    this.loadOperators(country, product);
                }
            });
        }
        
        const quantityInput = document.getElementById('quantityInput');
        if (quantityInput) {
            quantityInput.addEventListener('input', () => {
                if (this.selectedService.cost) {
                    this.updateTotalPrice();
                }
            });
        }
        
        const refreshPricesBtn = document.getElementById('refreshPricesBtn');
        if (refreshPricesBtn) {
            refreshPricesBtn.addEventListener('click', () => {
                const countrySelect = document.getElementById('countrySelect');
                const productSelect = document.getElementById('productSelect');
                const country = countrySelect ? countrySelect.value : null;
                const product = productSelect ? productSelect.value : null;
                if (country && product) {
                    this.loadOperators(country, product);
                }
            });
        }
        
        document.getElementById('purchaseBtn').addEventListener('click', () => {
            console.log('üîµ Purchase button clicked!');
            console.log('üìä Dashboard object:', this);
            this.purchaseService();
        });
        
        const refreshOrderBtn = document.getElementById('refreshOrderBtn');
        if (refreshOrderBtn) {
            refreshOrderBtn.addEventListener('click', () => {
                // Refresh recent orders instead of checking individual order status
                this.loadRecentOrders();
                this.showToast('Refreshing orders...', 'info');
            });
        }
    }
    
    async purchaseService() {
        console.log('üöÄ purchaseService called');
        console.log('üì± selectedService:', this.selectedService);
        
        if (!this.selectedService || !this.selectedService.countryCode) {
            console.log('‚ùå No service selected or missing countryCode');
            this.showToast('Please select a service first', 'error');
            return;
        }

        // Check for maximum of 3 active orders
        const activeOrders = document.querySelectorAll('#ordersTableBody tr:not(#noOrdersRow)');
        if (activeOrders.length >= 3) {
            // No limit on active orders anymore
            // this.showToast('You can only have 3 active orders at a time. Please cancel or wait for existing orders to expire.', 'error');
            // return;
        }

        // Check if CSRF token exists
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfToken) {
            this.showToast('Security token missing. Please refresh the page.', 'error');
            return;
        }
        
        // Show loading state on button
        const purchaseBtn = document.getElementById('purchaseBtn');
        const originalText = purchaseBtn.innerHTML;
        purchaseBtn.disabled = true;
        purchaseBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
        
        try {
            const formData = new FormData();
            formData.append('country', this.selectedService.countryCode);
            formData.append('operator', this.selectedService.operator);
            formData.append('product', this.selectedService.productCode);
            formData.append('csrfmiddlewaretoken', csrfToken.value);
            
            console.log('üìã Form data being sent:');
            console.log('  country:', this.selectedService.countryCode);
            console.log('  operator:', this.selectedService.operator);
            console.log('  product:', this.selectedService.productCode);
            console.log('  csrf token:', csrfToken.value);
            console.log('üöÄ Making fetch request to /api/5sim/buy-activation/...');
            
            const response = await fetch('/api/5sim/buy-activation/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            });
            
            console.log('üåê Network response received:', response.status, response.statusText);
            
            const result = await response.json();
            
            if (result.success) {
                // Store order ID for refresh functionality
                this.currentOrderId = result.order_id;
                
                // Load recent orders to show the new purchase
                this.loadRecentOrders();
                
                // Refresh user balance
                this.refreshUserBalance();
                
                // Show success notification with phone number
                this.showToast('SMS number purchased successfully!', 'success');
            } else {
                this.showToast('Purchase failed: ' + (result.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            console.error('Purchase error:', error);
            this.showToast('Network error occurred. Please try again.', 'error');
        } finally {
            // Restore button state
            const purchaseBtn = document.getElementById('purchaseBtn');
            purchaseBtn.disabled = false;
            purchaseBtn.innerHTML = '<i class="fas fa-shopping-cart me-2"></i>Purchase SMS Number';
        }
    }
    
    async loadRecentOrders() {
        try {
            const response = await fetch('/api/5sim/orders/');
            const result = await response.json();
            
            if (result.success && result.orders && result.orders.length > 0) {
                this.displayOrdersTable(result.orders);
            } else {
                this.showNoOrders();
            }
        } catch (error) {
            console.error('Error loading recent orders:', error);
            this.showNoOrders();
        }
    }
    
    displayOrdersTable(orders) {
        const ordersTableBody = document.getElementById('ordersTableBody');
        const noOrdersRow = document.getElementById('noOrdersRow');
        
        if (!ordersTableBody) return;
        
        // Clear existing order rows but keep the no orders row
        const orderRows = ordersTableBody.querySelectorAll('tr:not(#noOrdersRow)');
        orderRows.forEach(row => row.remove());
        
        if (orders && orders.length > 0) {
            // Filter out canceled orders
            const activeOrders = orders.filter(order => order.status !== 'CANCELED');
            
            if (activeOrders.length > 0) {
                // Hide the no orders row
                if (noOrdersRow) noOrdersRow.style.display = 'none';
                
                // Add orders to table
                activeOrders.forEach(order => {
                    this.addOrderToTable(order);
                });
                
                // No countdown timers needed for 5sim orders
                // this.startOrderTimers();
            } else {
                // Show the no orders row if all orders are canceled
                if (noOrdersRow) noOrdersRow.style.display = '';
            }
        } else {
            // Show the no orders row
            if (noOrdersRow) noOrdersRow.style.display = '';
        }
    }
    
    addOrderToTable(order) {
        const ordersTableBody = document.getElementById('ordersTableBody');
        const noOrdersRow = document.getElementById('noOrdersRow');
        
        if (!ordersTableBody) return;
        
        // Hide the no orders row when adding actual orders
        if (noOrdersRow) noOrdersRow.style.display = 'none';
        
        const row = document.createElement('tr');
        row.id = `order-${order.id}`;
        row.dataset.orderId = order.id;
        row.dataset.expiresAt = order.expires_at;
        row.dataset.status = order.status;
        
        const serviceCell = `<td><span class="badge bg-primary">${order.product || 'Unknown'}</span></td>`;
        const countryCell = `<td>${order.country || 'Unknown'}</td>`;
        const numberCell = `<td><code>${order.phone_number || 'N/A'}</code></td>`;
        const ttlCell = `<td id="ttl-${order.id}"><span class="badge bg-warning">--</span></td>`;
        
        let codeCell;
        if (order.sms_code) {
            codeCell = `<td id="code-${order.id}"><code class="text-success">${order.sms_code}</code></td>`;
        } else {
            codeCell = `<td id="code-${order.id}"><span class="text-muted">Waiting...</span></td>`;
        }
        
        row.innerHTML = serviceCell + countryCell + numberCell + ttlCell + codeCell;
        ordersTableBody.appendChild(row);
    }
    
    showNoOrders() {
        const ordersTableBody = document.getElementById('ordersTableBody');
        const noOrdersRow = document.getElementById('noOrdersRow');
        
        if (!ordersTableBody) return;
        
        // Clear existing order rows but keep the no orders row
        const orderRows = ordersTableBody.querySelectorAll('tr:not(#noOrdersRow)');
        orderRows.forEach(row => row.remove());
        
        // Show the no orders row
        if (noOrdersRow) noOrdersRow.style.display = '';
    }
    
    startOrderTimers() {
        // Clear existing timer if running
        if (this.orderTimerInterval) {
            clearInterval(this.orderTimerInterval);
        }
        
        // Start new timer that updates every second
        this.orderTimerInterval = setInterval(() => {
            this.updateOrderTimers();
        }, 1000);
        
        // Initial update
        this.updateOrderTimers();
        
        // Start SMS checking timer (every 10 seconds)
        if (this.smsCheckInterval) {
            clearInterval(this.smsCheckInterval);
        }
        
        this.smsCheckInterval = setInterval(() => {
            this.checkOrdersForSMS();
        }, 10000);
    }
    
    updateOrderTimers() {
        const orderRows = document.querySelectorAll('[data-order-id]');
        
        orderRows.forEach(row => {
            const orderId = row.dataset.orderId;
            const expiresAt = new Date(row.dataset.expiresAt);
            const status = row.dataset.status;
            const ttlElement = document.getElementById(`ttl-${orderId}`);
            const codeElement = document.getElementById(`code-${orderId}`);
            
            if (!ttlElement) return;
            
            // Remove row if order is canceled
            if (status === 'CANCELED') {
                row.remove();
                return;
            }
            
            // Check if SMS code has been received (not just status)
            const hasSmsCode = codeElement && codeElement.querySelector('code.text-success');
            
            // Only show checkmark if we actually have an SMS code
            if (hasSmsCode) {
                ttlElement.innerHTML = '<span class="text-success">‚úÖ</span>';
                return;
            }
            
            const now = new Date();
            const timeLeft = Math.max(0, Math.floor((expiresAt - now) / 1000));
            
            if (timeLeft > 0) {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                // Color code based on time remaining
                let badgeClass = 'bg-success';
                if (timeLeft < 60) badgeClass = 'bg-light text-dark';
                else if (timeLeft < 180) badgeClass = 'bg-warning';
                
                // Show countdown with cancel option
                ttlElement.innerHTML = `
                    <span class="badge ${badgeClass} countdown-timer">${timeString}</span>
                    <button class="btn btn-sm btn-link text-danger p-0 ms-1" 
                            onclick="dashboard.cancelOrder('${orderId}')" 
                            title="Cancel order">‚ùå</button>
                `;
            } else {
                // Time expired - remove the row
                console.log(`Order ${orderId} expired, removing row`);
                row.remove();
                
                // Check if table is empty (only has noOrdersRow)
                const tbody = document.getElementById('ordersTableBody');
                const noOrdersRow = document.getElementById('noOrdersRow');
                const remainingOrders = tbody ? tbody.querySelectorAll('tr:not(#noOrdersRow)') : [];
                
                if (remainingOrders.length === 0 && noOrdersRow) {
                    noOrdersRow.style.display = '';
                }
            }
        });
    }
    
    async checkOrdersForSMS() {
        const orderRows = document.querySelectorAll('[data-order-id]');
        
        for (const row of orderRows) {
            const orderId = row.dataset.orderId;
            const status = row.dataset.status;
            const codeElement = document.getElementById(`code-${orderId}`);
            
            // Skip if already has SMS code displayed
            if (codeElement && codeElement.querySelector('code.text-success')) {
                continue;
            }
            
            // Skip if order is already finished/cancelled
            if (status === 'FINISHED' || status === 'CANCELLED') {
                continue;
            }
            
            try {
                const response = await fetch(`/api/5sim/order/${orderId}/status/`);
                const result = await response.json();
                
                if (result.success && result.sms_code) {
                    // Update the code cell with the actual SMS code
                    codeElement.innerHTML = `<code class="text-success">${result.sms_code}</code>`;
                    
                    // Update dataset status
                    row.dataset.status = result.status || 'RECEIVED';
                    
                    // The TTL will be updated to show ‚úÖ in the next timer update
                    
                    // Show success notification
                    this.showToast(`SMS code received for ${result.phone_number || 'your number'}!`, 'success');
                }
            } catch (error) {
                console.warn(`Failed to check SMS for order ${orderId}:`, error);
            }
        }
    }
    
    async cancelOrder(orderId) {
        try {
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            const response = await fetch(`/api/5sim/order/${orderId}/cancel/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Show refund message
                const refundMessage = result.message || 'Order cancelled successfully';
                this.showToast(refundMessage, 'success');
                
                // Refresh user balance
                this.refreshUserBalance();
                
                // Remove the row from table immediately
                const row = document.getElementById(`order-${orderId}`);
                if (row) {
                    row.remove();
                    console.log(`Order ${orderId} cancelled and row removed`);
                    
                    // Check if table is empty and show "no orders" message if needed
                    const tbody = document.getElementById('ordersTableBody');
                    const noOrdersRow = document.getElementById('noOrdersRow');
                    const remainingOrders = tbody ? tbody.querySelectorAll('tr:not(#noOrdersRow)') : [];
                    
                    if (remainingOrders.length === 0 && noOrdersRow) {
                        noOrdersRow.style.display = '';
                        console.log('No more orders - showing no orders message');
                    }
                } else {
                    console.warn(`Row with ID order-${orderId} not found for removal`);
                    // Fallback: reload the entire orders table
                    this.loadRecentOrders();
                }
            } else {
                this.showToast('Failed to cancel order: ' + (result.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            console.error('Error cancelling order:', error);
            this.showToast('Network error occurred while cancelling order', 'error');
        }
    }
    
    async refreshUserBalance() {
        try {
            const response = await fetch('/api/balance/');
            if (response.ok) {
                const data = await response.json();
                const navbarBalanceElement = document.getElementById('navbar-balance');
                if (navbarBalanceElement && data.balance_naira) {
                    navbarBalanceElement.textContent = `‚Ç¶${data.balance_naira}`;
                }
            }
        } catch (error) {
            console.error('Failed to refresh balance:', error);
        }
    }
    
    showToast(message, type = 'info') {
        const alertClass = type === 'error' ? 'danger' : type;
        const toast = document.createElement('div');
        toast.className = `alert alert-${alertClass} alert-dismissible fade show position-fixed`;
        toast.style.cssText = `
            top: 20px; 
            right: 20px; 
            left: 20px;
            z-index: 9999; 
            max-width: 350px;
            font-size: 0.875rem;
            word-wrap: break-word;
        `;
        
        // Make it responsive for mobile
        if (window.innerWidth <= 768) {
            toast.style.cssText = `
                top: 20px; 
                left: 10px; 
                right: 10px;
                z-index: 9999; 
                font-size: 0.8rem;
                word-wrap: break-word;
            `;
        }
        
        toast.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(toast);
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 4000); // Reduced from 5000 to 4000ms
    }
}

// Global function to refresh balance from anywhere
window.refreshUserBalance = async function() {
    if (window.dashboard && window.dashboard.refreshUserBalance) {
        await window.dashboard.refreshUserBalance();
    } else {
        // Fallback if dashboard is not available
        try {
            const response = await fetch('/api/balance/');
            if (response.ok) {
                const data = await response.json();
                const navbarBalanceElement = document.getElementById('navbar-balance');
                if (navbarBalanceElement && data.balance_naira) {
                    navbarBalanceElement.textContent = `‚Ç¶${data.balance_naira}`;
                }
            }
        } catch (error) {
            console.error('Failed to refresh balance:', error);
        }
    }
};

// Initialize dashboard when page loads
let dashboard;
document.addEventListener('DOMContentLoaded', () => {
    console.log('üéØ DOM Content Loaded - initializing dashboard...');
    
    // Add a simple test event listener to verify button works
    const testBtn = document.getElementById('purchaseBtn');
    if (testBtn) {
        console.log('üîç Adding test event listener to purchase button...');
        testBtn.addEventListener('click', (e) => {
            console.log('üî• BUTTON CLICKED! Event:', e);
            console.log('üî• Button element:', e.target);
        });
    } else {
        console.error('‚ùå Purchase button not found for test listener!');
    }
    
    try {
        dashboard = new SMSDashboard();
        console.log('‚úÖ Dashboard instance created:', dashboard);
    } catch (error) {
        console.error('‚ùå Error creating dashboard:', error);
    }
});
</script>

{% endblock %}
