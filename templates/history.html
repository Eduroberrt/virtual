{% extends 'main.html' %}
{% load currency_filters %}

{% block title %}Rental History - Young PG Virtual{% endblock %}

{% block extra_css %}
<style>
    /* Mobile table scrolling improvements */
    .table-responsive {
        font-size: 0.8rem;
    }
    
    .table td, .table th {
        padding: 0.5rem 0.25rem;
        vertical-align: middle;
        font-size: 0.8rem;
    }
    
    @media (max-width: 768px) {
        .table-responsive {
            font-size: 0.75rem;
        }
        
        .table td, .table th {
            padding: 0.4rem 0.2rem;
            font-size: 0.75rem;
        }
    }
    
    @media (max-width: 576px) {
        .table-responsive {
            font-size: 0.7rem;
        }
        
        .table td, .table th {
            padding: 0.3rem 0.15rem;
            min-width: auto;
            font-size: 0.7rem;
        }
    }

/* Dark mode overrides for history page */
[data-theme="dark"] .card {
    background: #000000 !important;
    border: 1px solid var(--success-color) !important;
    color: #ffffff !important;
}

[data-theme="dark"] .card-header {
    background: #000000 !important;
    color: #ffffff !important;
    border-bottom: 1px solid var(--success-color) !important;
}

[data-theme="dark"] .card-body {
    background: #000000 !important;
    color: #ffffff !important;
}

[data-theme="dark"] .card-title {
    color: #ffffff !important;
}

[data-theme="dark"] .table {
    background: #000000 !important;
    color: #ffffff !important;
}

[data-theme="dark"] .table th,
[data-theme="dark"] .table td {
    background: #000000 !important;
    color: #ffffff !important;
    border-color: #404040 !important;
}

[data-theme="dark"] .table-striped tbody tr:nth-of-type(odd) {
    background: #1a1a1a !important;
}

[data-theme="dark"] .table-hover tbody tr:hover {
    background: #1a1a1a !important;
    color: #ffffff !important;
}

[data-theme="dark"] .text-muted {
    color: #b3b3b3 !important;
}

[data-theme="dark"] .text-dark {
    color: #ffffff !important;
}

/* Pagination styles (copied from payments page) */
.pagination-wrapper {
    display: flex;
    justify-content: center;
}

.pagination-container {
    display: flex;
    justify-content: center;
    align-items: center;
}

.pagination-buttons {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.pagination-btn {
    padding: 0.75rem 1rem;
    border: 2px solid #e9ecef;
    background: white;
    color: #333;
    border-radius: 10px;
    font-weight: 500;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.pagination-btn:hover {
    border-color: #198754;
    color: #198754;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(25, 135, 84, 0.2);
}

.pagination-btn.active {
    background: linear-gradient(135deg, #198754 0%, #146c43 100%);
    border-color: #198754;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(25, 135, 84, 0.3);
}

.pagination-number {
    min-width: 45px;
    justify-content: center;
}

.pagination-prev, .pagination-next {
    font-weight: 600;
}

.pagination-ellipsis {
    padding: 0.75rem 0.5rem;
    color: #666;
    font-weight: 500;
}

/* Dark mode pagination styling */
[data-theme="dark"] .pagination-btn {
    background: #000000 !important;
    border-color: #404040 !important;
    color: #ffffff !important;
}

[data-theme="dark"] .pagination-btn:hover {
    border-color: #198754 !important;
    color: #198754 !important;
    background: #1a1a1a !important;
}

[data-theme="dark"] .pagination-btn.active {
    background: linear-gradient(135deg, #198754 0%, #146c43 100%) !important;
    border-color: #198754 !important;
    color: white !important;
}

[data-theme="dark"] .pagination-ellipsis {
    color: #b3b3b3 !important;
}

/* Mobile responsive pagination */
@media (max-width: 768px) {
    .pagination-buttons {
        gap: 0.25rem;
    }
    
    .pagination-btn {
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
    }
    
    .pagination-number {
        min-width: 35px;
    }
    
    .pagination-prev .fas,
    .pagination-next .fas {
        display: none;
    }
}

/* Dark mode icons styling */
[data-theme="dark"] input[type="date"] {
    color-scheme: dark;
}

[data-theme="dark"] input[type="date"]::-webkit-calendar-picker-indicator {
    filter: invert(1);
    color: #ffffff !important;
}

[data-theme="dark"] .fas.fa-filter {
    color: #ffffff !important;
}

[data-theme="dark"] .fas.fa-search {
    color: #ffffff !important;
}

[data-theme="dark"] .fas.fa-times {
    color: #ffffff !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4" style="margin-bottom: 120px;">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h4 fw-bold mb-2">Rental history</h1>
                    <p class="text-muted mb-0" style="font-size: 0.875rem;">The table below displays your previous successful rentals.</p>
                    <small class="text-muted" style="font-size: 0.8rem;">Time is in America/Los_Angeles time zone. The last 365 days are shown.</small>
                </div>
                <div>
                    <a href="/dashboard/" class="btn btn-outline-success">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>

            <!-- Filter Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-filter me-2"></i>Filter
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="serviceFilter" class="form-label">Service</label>
                            <select class="form-select" id="serviceFilter">
                                <option value="">All Services</option>
                                {% for service in services %}
                                <option value="{{ service.name }}">{{ service.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="statusFilter" class="form-label">Status</label>
                            <select class="form-select" id="statusFilter">
                                <option value="">All Statuses</option>
                                <option value="RECEIVED">Completed</option>
                                <option value="CANCELLED">Cancelled</option>
                                <option value="EXPIRED">Expired</option>
                                <option value="WAITING">Waiting</option>
                                <option value="DONE">Done</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="dateFrom" class="form-label">From Date</label>
                            <input type="date" class="form-control" id="dateFrom">
                        </div>
                        <div class="col-md-3">
                            <label for="dateTo" class="form-label">To Date</label>
                            <input type="date" class="form-control" id="dateTo">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button class="btn btn-primary" onclick="applyFilters()">
                                <i class="fas fa-search me-2"></i>Apply Filters
                            </button>
                            <button class="btn btn-outline-secondary ms-2" onclick="clearFilters()">
                                <i class="fas fa-times me-2"></i>Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History Table -->
            <div class="card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped mb-0" style="min-width: 600px;">
                            <thead class="table-dark">
                                <tr>
                                    <th style="min-width: 60px;">ID</th>
                                    <th style="min-width: 100px;">Service</th>
                                    <th style="min-width: 110px;">Phone</th>
                                    <th style="min-width: 70px;">Price</th>
                                    <th style="min-width: 80px;">Code</th>
                                    <th style="min-width: 120px;">Date</th>
                                    <th style="min-width: 80px;">Status</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <tr>
                                    <td colspan="7" class="text-center py-4">
                                        <div class="d-flex justify-content-center">
                                            <div class="spinner-border text-primary me-3" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <span class="text-muted">Loading rental history...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Pagination -->
            <div class="pagination-wrapper mt-4">
                <div class="pagination-container" id="paginationControls">
                    <!-- Pagination will be populated by JavaScript -->
                </div>
            </div>

            <!-- Statistics -->
            <div class="row mt-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-primary">Total Rentals</h5>
                            <h3 class="card-text" id="totalRentals">-</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-success">Successful</h5>
                            <h3 class="card-text" id="successfulRentals">-</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-warning">Cancelled</h5>
                            <h3 class="card-text" id="cancelledRentals">-</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-info">Total Spent</h5>
                            <h3 class="card-text" id="totalSpent">-</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let totalPages = 1;
let allRentals = [];
let filteredRentals = [];

document.addEventListener('DOMContentLoaded', function() {
    // Set default date range (last 30 days)
    const today = new Date();
    const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
    
    document.getElementById('dateTo').value = today.toISOString().split('T')[0];
    document.getElementById('dateFrom').value = thirtyDaysAgo.toISOString().split('T')[0];
    
    // Load rental history
    loadRentalHistory();
});

async function loadRentalHistory() {
    try {
        // Build query parameters
        const params = new URLSearchParams({
            page: currentPage,
            limit: 20
        });
        
        // Add filters if they exist
        const serviceFilter = document.getElementById('serviceFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        
        if (serviceFilter) params.append('service', serviceFilter);
        if (statusFilter) params.append('status', statusFilter);
        if (dateFrom) params.append('date_from', dateFrom);
        if (dateTo) params.append('date_to', dateTo);
        
        const response = await fetch(`/api/rental-history/?${params}`);
        const data = await response.json();
        
        if (data.success && data.rentals) {
            allRentals = data.rentals;
            filteredRentals = data.rentals;
            totalPages = data.total_pages;
            
            renderHistoryTable();
            renderPagination();
            updateStatisticsFromAPI(data.statistics);
        } else {
            showEmptyState();
        }
    } catch (error) {
        console.error('Error loading rental history:', error);
        showErrorState();
    }
}

function applyFilters() {
    currentPage = 1;
    loadRentalHistory(); // Reload with filters
}

function clearFilters() {
    document.getElementById('serviceFilter').value = '';
    document.getElementById('statusFilter').value = '';
    
    // Reset to last 30 days
    const today = new Date();
    const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
    
    document.getElementById('dateTo').value = today.toISOString().split('T')[0];
    document.getElementById('dateFrom').value = thirtyDaysAgo.toISOString().split('T')[0];
    
    applyFilters();
}

function renderHistoryTable() {
    const tbody = document.getElementById('historyTableBody');
    
    if (filteredRentals.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-5">
                    <div class="text-muted">
                        <i class="fas fa-history fa-3x mb-3"></i>
                        <h5>No rental history found</h5>
                        <p>Try adjusting your filters or check back later.</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = filteredRentals.map(rental => {
        const date = new Date(rental.created_at);
        const formattedDate = formatDateToLA(date);
        const priceNaira = parseFloat(rental.price_naira.replace(/,/g, ''));
        
        // Determine status display
        let status = rental.status;
        let statusClass = 'secondary';
        
        switch(rental.status) {
            case 'RECEIVED':
                status = 'Completed';
                statusClass = 'success';
                break;
            case 'CANCELLED':
                status = 'Cancelled';
                statusClass = 'warning';
                break;
            case 'EXPIRED':
                status = 'Expired';
                statusClass = 'danger';
                break;
            case 'WAITING':
                status = 'Waiting';
                statusClass = 'info';
                break;
            case 'DONE':
                status = 'Done';
                statusClass = 'success';
                break;
        }
        
        return `
            <tr>
                <td>
                    <span class="font-monospace">${rental.rental_id.slice(-6)}</span>
                </td>
                <td>
                    <span class="fw-medium">${rental.service_name}</span>
                </td>
                <td>
                    <span class="font-monospace">${rental.phone_number}</span>
                </td>
                <td>
                    <span class="fw-medium">₦${formatCurrency(priceNaira)}</span>
                </td>
                <td>
                    ${rental.code ? `
                        <span class="fw-medium">${rental.code}</span>
                    ` : '<span class="text-muted">N/A</span>'}
                </td>
                <td>
                    <span class="fw-medium">${formattedDate}</span>
                </td>
                <td>
                    <span class="badge bg-${statusClass}">${status}</span>
                </td>
            </tr>
        `;
    }).join('');
}

function renderPagination() {
    const pagination = document.getElementById('paginationControls');
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let paginationHTML = '<div class="pagination-buttons">';
    
    // Previous button
    if (currentPage > 1) {
        paginationHTML += `
            <button class="pagination-btn pagination-prev" onclick="changePage(${currentPage - 1})" aria-label="Previous">
                <i class="fas fa-chevron-left"></i>
                Previous
            </button>
        `;
    }
    
    // Page numbers logic
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    // First page and ellipsis
    if (startPage > 1) {
        paginationHTML += `<button class="pagination-btn pagination-number" onclick="changePage(1)">1</button>`;
        if (startPage > 2) {
            paginationHTML += `<span class="pagination-ellipsis">...</span>`;
        }
    }
    
    // Visible page numbers
    for (let i = startPage; i <= endPage; i++) {
        if (i === currentPage) {
            paginationHTML += `<button class="pagination-btn pagination-number active">${i}</button>`;
        } else {
            paginationHTML += `<button class="pagination-btn pagination-number" onclick="changePage(${i})">${i}</button>`;
        }
    }
    
    // Last page and ellipsis
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            paginationHTML += `<span class="pagination-ellipsis">...</span>`;
        }
        paginationHTML += `<button class="pagination-btn pagination-number" onclick="changePage(${totalPages})">${totalPages}</button>`;
    }
    
    // Next button
    if (currentPage < totalPages) {
        paginationHTML += `
            <button class="pagination-btn pagination-next" onclick="changePage(${currentPage + 1})" aria-label="Next">
                Next
                <i class="fas fa-chevron-right"></i>
            </button>
        `;
    }
    
    paginationHTML += '</div>';
    pagination.innerHTML = paginationHTML;
}

function changePage(page) {
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    loadRentalHistory(); // Reload data for the new page
}

function updateStatisticsFromAPI(stats) {
    document.getElementById('totalRentals').textContent = stats.total_rentals;
    document.getElementById('successfulRentals').textContent = stats.successful_rentals;
    document.getElementById('cancelledRentals').textContent = stats.cancelled_rentals;
    document.getElementById('totalSpent').textContent = `₦${formatCurrency(parseFloat(stats.total_spent_naira.replace(/,/g, '')))}`;
}

function updateStatistics() {
    // This function is now replaced by updateStatisticsFromAPI
    // Keeping for backward compatibility
}

function formatDateToLA(date) {
    // Convert to Los Angeles timezone
    const options = {
        timeZone: 'America/Los_Angeles',
        day: '2-digit',
        month: 'short',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        timeZoneName: 'short'
    };
    
    return new Intl.DateTimeFormat('en-US', options).format(date);
}

function showEmptyState() {
    const tbody = document.getElementById('historyTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="7" class="text-center py-5">
                <div class="text-muted">
                    <i class="fas fa-history fa-3x mb-3"></i>
                    <h5>No rental history</h5>
                    <p>You haven't made any rentals yet. <a href="/dashboard/">Start renting</a> to see your history here.</p>
                </div>
            </td>
        </tr>
    `;
}

function showErrorState() {
    const tbody = document.getElementById('historyTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="7" class="text-center py-5">
                <div class="text-danger">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <h5>Error loading history</h5>
                    <p>Unable to load rental history. Please try again later.</p>
                    <button class="btn btn-outline-primary" onclick="loadRentalHistory()">
                        <i class="fas fa-refresh me-2"></i>Retry
                    </button>
                </div>
            </td>
        </tr>
    `;
}

function formatCurrency(amount) {
    try {
        return parseFloat(amount).toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    } catch (e) {
        return '0.00';
    }
}
</script>
{% endblock %}
